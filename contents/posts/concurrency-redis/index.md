---
title: "ì„ ì°©ìˆœ í‹°ì¼“íŒ…ì— Redis ë„ì…í•˜ê¸°"
description: "í˜ìŠ¤íƒ€ê³ íŒ€ì˜ ì„ ì°©ìˆœ í‹°ì¼“íŒ… ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ Redis ë„ì…ê¸°ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤."
date: 2023-09-10
update: 2023-09-10
tags:
- Redis
---

ì•ˆë…•í•˜ì„¸ìš”.

í˜ìŠ¤íƒ€ê³ ì˜ ì• ì‰¬ ì…ë‹ˆë‹¤. ğŸ¹

â€˜ëŒ€í•™ ì¶•ì œ ì¤„ì„œê¸° ì„œë¹„ìŠ¤â€™ í˜ìŠ¤íƒ€ê³ ë¥¼ ê°œë°œí•˜ë©°, í‹°ì¼“íŒ… ìƒí™©ì—ì„œ ë™ì‹œì„± ë³´ì¥ì„ ìœ„í•´ Redisë¥¼ ë„ì…í•´ë³´ì•˜ìŠµë‹ˆë‹¤.


ì•„ë˜ëŠ” ì €í¬ íŒ€ì˜ ìš”êµ¬ì‚¬í•­ê³¼ ë¬¸ì œ ìƒí™©, ê·¸ë¦¬ê³  í•´ë‹¹ ë¬¸ì œ ìƒí™©ì˜ í•´ê²°ì±…ìœ¼ë¡œ Redisë¥¼ ë„ì…í•œ ì´ìœ ì…ë‹ˆë‹¤.


## 1. ìš”êµ¬ì‚¬í•­

í‹°ì¼“ì€ ì§€ì •ëœ ìˆ˜ëŸ‰ë§Œí¼ë§Œ ë°œê¸‰ë˜ì–´ì•¼í•©ë‹ˆë‹¤.

## 2. ë¬¸ì œ ìƒí™©

ë™ì‹œì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì˜ˆë§¤í•  ë•Œ, ì§€ì •ëœ ìˆ˜ëŸ‰ë³´ë‹¤ ë” ë§ì€ ìˆ˜ëŸ‰ì˜ í‹°ì¼“ì´ ì˜ˆë§¤ë©ë‹ˆë‹¤.

![](images/ë¬¸ì œìƒí™©.png)

## 3. í˜„ì¬ í•´ê²°ì±…

í‹°ì¼“ ìˆ˜ëŸ‰ì˜ ì •í•©ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•˜ì—¬, **ë¹„ê´€ì  ë½**ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ë¹„ê´€ì  ë½ì€ ë½ì„ ì–»ê¸° ìœ„í•œ ëŒ€ê¸°ì‹œê°„ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì ìœ¼ë¡œ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 3-1. í˜„ì¬ì˜Â ì„±ëŠ¥ ê°œì„ ì±…

#### TicketAmount í…Œì´ë¸” ë¶„ë¦¬
![](images/ticketë„ë©”ì¸êµ¬ì¡°.png)

Ticket í…Œì´ë¸”ì—ì„œ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ TicketAmount í…Œì´ë¸”ë¡œ ë¶„ë¦¬í•œ í›„, í•´ë‹¹ í…Œì´ë¸”ì—ë§Œ ë¹„ê´€ì  ë½ì„ ì ìš©í•¨ìœ¼ë¡œì¨ **ë½ ë²”ìœ„ë¥¼ ìµœì†Œí™”**í–ˆìŠµë‹ˆë‹¤.

![](images/lockë²”ìœ„.png)


#### N+1 ì¿¼ë¦¬ ì œê±°
![](images/n+1.png)
Fetch Joinì„ í™œìš©í•´ N+1 ì¿¼ë¦¬ë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.



â‡’ ê²°ê³¼ì ìœ¼ë¡œ **10% ì •ë„ì˜ ì„±ëŠ¥ ê°œì„ **ì„ ì´ë£¨ì–´ë‚¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.


## 4. ì•ìœ¼ë¡œì˜ ì„±ëŠ¥ ê°œì„ ì±…

ì„œë²„ ë‹¨ì—ì„œ ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ì¼ë°˜ì ìœ¼ë¡œ ìºì‹±ê³¼ DB ì¸ë±ìŠ¤ë¥¼ í™œìš©í•˜ê³¤ í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ í‹°ì¼“ ì˜ˆë§¤ ë¡œì§ì—ì„œ ê°€ì¥ í° ë³‘ëª©ì€ ë°ì´í„°ì˜ ì¡°íšŒê°€ ì•„ë‹Œ **Lockì„ ì–»ê¸° ìœ„í•œ ëŒ€ê¸°ë¡œ ì¸í•´ ë°œìƒ**í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, **ê°€ëŠ¥í•œ Lockì„ ê±¸ì§€ ì•ŠëŠ” ê²ƒ**ì´ ì„±ëŠ¥ì„ í–¥ìƒ ì‹œí‚¤ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ì €í¬ëŠ” **DBì˜ í‹°ì¼“ ìˆ˜ëŸ‰ì„ ë³€ê²½**í•  ë•Œ, ì •í•©ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ì„œ Lockì„ ê²ë‹ˆë‹¤.

ë”°ë¼ì„œ, **DBì˜ í‹°ì¼“ ìˆ˜ëŸ‰ì„ ë³€ê²½í•˜ì§€ ì•ŠëŠ” í•´ê²°ì±…**ì„ ì°¾ê³ ì í–ˆìŠµë‹ˆë‹¤.

### 4-1. AtomicIntegerì˜ í™œìš©

ì²«ë²ˆì§¸ í•´ê²°ì±…ìœ¼ë¡œ AtomicIntegerë¥¼ í™œìš©í•´ **ë©”ëª¨ë¦¬ì—ì„œ í‹°ì¼“ì˜ ìˆ˜ëŸ‰ì„ ë³€ê²½í•˜ê³  ê´€ë¦¬**í•˜ê³ ì í–ˆìŠµë‹ˆë‹¤.

![](images/atomicInteger.png)

ì´ ë°©ë²•ì€ DBì˜ ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, ë™ì‹œ ì˜ˆë§¤ ìƒí™©ì—ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì§€ê¸ˆì˜ ë‹¨ì¼ ì„œë²„ì—ì„œëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ, ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•œ ë‹¤ì¤‘ ì„œë²„ í™˜ê²½ì—ì„œëŠ” ë©”ëª¨ë¦¬ ê³µìœ  ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

í‹°ì¼“ì˜ ìˆ˜ëŸ‰ì€ ë‹¨ìˆœíˆ ì¡°íšŒí•˜ëŠ” ê°’ì´ ì•„ë‹Œ ë§¤ ìš”ì²­ë§ˆë‹¤ ë³€ê²½ë˜ëŠ” ê°’ì´ê¸° ë•Œë¬¸ì— ë™ê¸°í™”ì—ì„œ ë¬¸ì œ ë°œìƒì´ ìš°ë ¤ë©ë‹ˆë‹¤.

### 4-2. Redis í™œìš©

AtomicIntegerì˜ ëŒ€ì²´ì œë¡œ Redisë¥¼ í™œìš©í–ˆìŠµë‹ˆë‹¤.

RedisëŠ” ì‹±ê¸€ ìŠ¤ë ˆë“œì´ë©° multiplexing ê¸°ìˆ ì„ í™œìš©í•˜ì—¬ ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ê°€ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ëª¨ë“  ìš”ì²­ì´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

ë„¤íŠ¸ì›Œí¬ I/Oê°€ ì¡´ì¬í•˜ì§€ë§Œ, ê·¸ëŸ¼ì—ë„ DBì— ë½ì„ ê±°ëŠ” ê²ƒ ë³´ë‹¤ ì„±ëŠ¥ì´ í›¨ì”¬ ë›°ì–´ë‚©ë‹ˆë‹¤.

3000ê°œì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ”ë° DB ë½ì„ í™œìš©í•œ ë°©ë²•ì€ í‰ê·  12800msê°€ ì†Œìš”ë˜ëŠ” ë°˜ë©´, Redisë¥¼ í™œìš©í•œ ë°©ë²•ì€ í‰ê·  7500msì´ ì†Œìš”ë©ë‹ˆë‹¤. ì´ëŠ” **40% ì´ìƒì˜ ì„±ëŠ¥ ê°œì„ **ì…ë‹ˆë‹¤.

| DB ë½ | Redis |
| --- | --- |
| 12764 | 8249 |
| 14217 | 7350 |
| 12177 | 7123 |
| 11969 | 7414 |


## 5. ì¶”ê°€ì ì¸ í™œìš©ë²•

ì €í¬ ì„œë¹„ìŠ¤ì˜ ìš”êµ¬ì‚¬í•­ìœ¼ë¡œ, í•œ ì‚¬ìš©ìëŠ” íŠ¹ì • ë¬´ëŒ€ì— ëŒ€í•´ í•œ ì¥ì˜ í‹°ì¼“ë§Œ ë°œê¸‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì„ ë³´ë‚´ë©´, í‹°ì¼“ì´ ì—¬ëŸ¬ ì¥ ë°œê¸‰ë˜ëŠ” ë¬¸ì œ(ì¼ëª… **â€œë”°ë‹¥â€ ë¬¸ì œ**)ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

![](images/ë”°ë‹¥.png)

ì´ëŠ” DBì˜ MemberTicket í…Œì´ë¸”ì— **(memberId, stageId) Unique ì œì•½ì¡°ê±´**ì„ ê±¸ì–´ì¤Œìœ¼ë¡œì¨ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ Unique ì œì•½ ì¡°ê±´ì€ Change Buffer ê¸°ëŠ¥ì„ ë¹„í™œì„±í™” ì‹œí‚´ìœ¼ë¡œ ë°ì´í„° ì‚½ì… ì—°ì‚°ì˜ ì„±ëŠ¥ì´ ì €í•˜ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

ë˜í•œ, í•œ ì‚¬ìš©ìë‹¹ ë°œê¸‰ ê°€ëŠ¥ íšŸìˆ˜ê°€ 1íšŒì—ì„œ 2íšŒë¡œ ë³€ê²½ë  ê²½ìš° í•´ë‹¹ ë°©ë²•ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ë”°ë‹¥ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ í•´ê²°ì±…ìœ¼ë¡œë„ Redisë¥¼ í™œìš©í•˜ì˜€ìŠµë‹ˆë‹¤.


### 5-1. ë”°ë‹¥ ë¬¸ì œ í•´ê²°í•˜ê¸°

í‹°ì¼“ ì˜ˆë§¤ ì‹œë„ì‹œ, í•´ë‹¹ memberIdì™€ stageIdì˜ ë³µí•©í‚¤ `trialCount_stageId_memberId` ì˜ ê°’ì„ incrementAndGet í•©ë‹ˆë‹¤.

í•´ë‹¹ ì—°ì‚°ì˜ ë°˜í™˜ê°’ì´, ë°œê¸‰ ê°€ëŠ¥ ë§¤ìˆ˜ë³´ë‹¤ í¬ë©´ ì˜ˆì™¸ì²˜ë¦¬í•©ë‹ˆë‹¤.

í•´ë‹¹ ì—°ì‚°ì€ í‹°ì¼“ ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ì—°ì‚°ê³¼ **ì›ìì ì¸ ë‹¨ìœ„**ë¡œ ë¬¶ì—¬ìˆê¸° ë•Œë¬¸ì—, ë™ì‹œ ì˜ˆë§¤ì˜ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” í•´ë‹¹ ì—°ì‚°ì˜ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

```lua
local memberTryCount = redis.call("INCR", KEYS[1])
redis.call("EXPIRE", KEYS[1], 1)

-- ë”°ë‹¥ì¸ ê²½ìš°
if memberTryCount > tonumber(ARGV[1])
then
  return -2
end

local remainAmount = redis.call("DECR", KEYS[2])

-- í’ˆì ˆì¸ ê²½ìš°
if remainAmount < 0
then
  return -1
end

return remainAmount
```

---

## **ì ìš© ì½”ë“œ ë§í¬**

[https://github.com/woowacourse-teams/2023-festa-go/pull/428](https://github.com/woowacourse-teams/2023-festa-go/pull/428)
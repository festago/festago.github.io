---
title: "í˜ìŠ¤íƒ€ê³ ì˜ ì¸ì¦ - OAuth2ë¥¼ ì„ íƒí•˜ê³  ì ìš©í•œ ë°©ë²•"
description: "í˜ìŠ¤íƒ€ê³ ì—ì„œ OAuth2ë¥¼ ì„ íƒí•œ ê³¼ì •ê³¼ ì–´ë–»ê²Œ ì ìš©ì„ í–ˆëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤."
date: 2023-08-20
update: 2023-08-20
tags:
- OAuth2
---

## ì„œë¡ 

ì•ˆë…•í•˜ì„¸ìš”.

í˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ

í˜ìŠ¤íƒ€ê³ ëŠ” ì¸ì¦ì„ êµ¬í˜„í•  ë•Œ, ìµœì†Œí•œì˜ ì •ë³´ë¡œ ì•ˆì „í•˜ê²Œ ì¸ì¦ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” OAuth2ë¥¼ ì±„íƒí•˜ì˜€ìŠµë‹ˆë‹¤.

OAuth2ë¥¼ êµ¬í˜„í•  ë•Œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” íšŒì‚¬ë“¤ì€ ë§¤ìš° ë§ìŠµë‹ˆë‹¤.

ê·¸ì¤‘ì—ì„œ ì €í¬ê°€ ì„ íƒí•œ OAuth2 ì œê³µìëŠ” `ì¹´ì¹´ì˜¤í†¡` ì…ë‹ˆë‹¤.

ì¹´ì¹´ì˜¤í†¡ì„ ì„ íƒí•œ ì´ìœ ëŠ” ì €í¬ ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ìƒ ì‚¬ìš©ì ê°„ì˜ í‹°ì¼“ ê±°ë˜ë¥¼ ë§‰ê¸° ìœ„í•¨ì¸ë°ìš”.

êµ¬ê¸€ì´ë‚˜ í˜ì´ìŠ¤ë¶ ë“± ì‰½ê²Œ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ëŠ” í•œ ëª…ì˜ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê³„ì •ì„ í†µí•´ í‹°ì¼“ì„ ì˜ˆë§¤í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, êµ­ë‚´ì—ì„œ ìœ ì¼í•œ ì „í™”ë²ˆí˜¸ë¡œ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ì œê³µìì¸ ì¹´ì¹´ì˜¤í†¡ì„ ì„ íƒí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

í˜ìŠ¤íƒ€ê³ ì—ì„œ êµ¬í˜„í•œ OAuth2ì˜ ì¸ì¦ í”Œë¡œìš°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![](images/20230819155223.png)

ì´ ë°©ì‹ì€ `Authorization Code Grant Type`ë¼ê³  ë¶ˆë¦¬ëŠ” OAuth2 ì¸ì¦ ë°©ì‹ì˜ ì¢…ë¥˜ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.

í•´ë‹¹ ì¸ì¦ ë°©ì‹ì€ ì‚¬ìš©ìëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” OAuth2 ì¸ì¦ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³ , ì¸ì¦ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸(ë°±ì—”ë“œ ìŠ¤í”„ë§ ì„œë²„)ì— ì—‘ì„¸ìŠ¤ í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì—‘ì„¸ìŠ¤ í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ì˜ ë…¸ì¶œì„ ìµœì†Œí™”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì•ˆì˜ ì‹ ë¢°ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ë°©ì‹ì„ ì–´ë–»ê²Œ ì½”ë“œë¡œ êµ¬í˜„í•˜ì˜€ëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

ì½”ë“œë¡œ êµ¬í˜„í•  í´ë˜ìŠ¤ë¥¼ ê°„ëµíˆ ë‚˜íƒ€ë‚¸ë‹¤ë©´ í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

`SocialType`: Enumìœ¼ë¡œ OAuth2ì˜ ì œê³µìë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (ex: KAKAO)

`AuthProvider`: ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì €í¬ì˜ ì—‘ì„¸ìŠ¤ í† í°ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

`AuthExtractor`: ì—‘ì„¸ìŠ¤ í† í°ì„ íŒŒì‹±í•˜ì—¬ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ê³  Payloadì˜ ê°’ì„ ì¶”ì¶œí•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

`OAuth2Client`: OAuth2 ì¸ì¦, ë¦¬ì†ŒìŠ¤ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ì—‘ì„¸ìŠ¤ í† í°, ì‚¬ìš©ì ì •ë³´ ë“± ë¯¼ê°í•œ ì •ë³´ë¥¼ ë°›ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

`Member`: ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” ì—”í‹°í‹°ë¡œ, `SocialType`ì„ í•„ë“œë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

`AuthService`: ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

ì—¬ê¸°ì„œ `OAuth2Client`ëŠ” ì™¸ë¶€ APIì— ì˜ì¡´í•˜ë¯€ë¡œ, ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ë‚˜ ë¡œì»¬ í™˜ê²½ì—ì„œ ëª¨ì˜ ê°ì²´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.
#### AuthProvider
```java
public class JwtAuthProvider implements AuthProvider {  
  
    private static final int SECOND_FACTOR = 60;  
    private static final int MILLISECOND_FACTOR = 1000;  
    private static final String MEMBER_ID_KEY = "memberId";
  
    private final SecretKey key;  
    private final long expirationMinutes;  
  
    public JwtAuthProvider(String secretKey, long expirationMinutes) {  
        this.key = Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8));  
        this.expirationMinutes = expirationMinutes;  
    }  
  
    @Override  
    public String provide(AuthPayload authPayload) {  
        Date now = new Date();  
        return Jwts.builder()  
            .claim(MEMBER_ID_KEY, authPayload.getMemberId())   
            .setIssuedAt(now)  
            .setExpiration(new Date(now.getTime() + expirationMinutes * SECOND_FACTOR * MILLISECOND_FACTOR))  
            .signWith(key, SignatureAlgorithm.HS256)  
            .compact();  
    }  
}
```

AuthProviderì˜ êµ¬í˜„ì²´ì¸ `JwtAuthProvider` ì…ë‹ˆë‹¤.

`Member` ì—”í‹°í‹°ì˜ PKë¥¼ Payloadì— ë„£ì–´ JWT í† í°ì„ ë°˜í™˜í•´ ì¤ë‹ˆë‹¤.

í•´ë‹¹ í† í°ì€ ì•ìœ¼ë¡œ ì €í¬ ì„œë²„ì— ì¸ì¦ ê³¼ì •ì— í•„ìš”í•œ ì—‘ì„¸ìŠ¤ í† í°ì…ë‹ˆë‹¤.

#### AuthExtractor
```java
public class JwtAuthExtractor implements AuthExtractor {  
  
    private static final String MEMBER_ID_KEY = "memberId";  
  
    private final JwtParser jwtParser;  
  
    public JwtAuthExtractor(String secretKey) {  
        SecretKey key = Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8));  
        this.jwtParser = Jwts.parserBuilder()  
            .setSigningKey(key)  
            .build();  
    }  
  
    @Override  
    public AuthPayload extract(String token) {  
        Claims claims = getClaims(token);  
        Long memberId = claims.get(MEMBER_ID_KEY, Long.class);  
        return new AuthPayload(memberId);  
    }  
  
    private Claims getClaims(String code) {  
        try {  
            return jwtParser.parseClaimsJws(code)  
                .getBody();  
        } catch (ExpiredJwtException e) {  
            throw new UnauthorizedException(ErrorCode.EXPIRED_AUTH_TOKEN);  
        } catch (JwtException | IllegalArgumentException e) {  
            throw new UnauthorizedException(ErrorCode.INVALID_AUTH_TOKEN);  
        }  
    }  
}
```

AuthExtractorì˜ êµ¬í˜„ì²´ì¸ `JwtAuthExtractor` ì…ë‹ˆë‹¤.

í† í°ì„ ë°›ì•„ `AuthPayload` ê°ì²´ë¡œ ë§Œë“¤ì–´ ë°˜í™˜í•©ë‹ˆë‹¤.

ì°¸ê³ ë¡œ í•„ë“œë¡œ `JwtParser`ë¥¼ ê°€ì§€ê³  ìˆëŠ”ë° ì´ëŠ” `Jwts.parserBuilder()` ë©”ì†Œë“œë¡œ ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ëŠ” ë¶ˆë³€í•˜ê³ , thread-safe í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

![](images/20230818023037.png)

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ íŒŒì‹±í•  ë•Œë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒˆë¡­ê²Œ ë§Œë“¤ì§€ ì•Šê³ , ê¸°ì¡´ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
// íŒŒì‹±ë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
return Jwts.parserBuilder()  
            .setSigningKey(key)  
            .build()
            .parseClaimsJws(code)  
            .getBody();

// íŒŒì‹±ë§ˆë‹¤ ê¸°ì¡´ì˜ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©
return jwtParser.parseClaimsJws(code)  
                .getBody();  
```

#### OAuth2Client
```java
@Component
public class KakaoOAuth2Client implements OAuth2Client {  
  
    private static final String ACCESS_TOKEN_URL = "https://kauth.kakao.com/oauth/token";  
    private static final String USER_INFO_URL = "https://kapi.kakao.com/v2/user/me";  
  
    private final RestTemplate restTemplate;  
    private final String grantType;  
    private final String clientId;  
    private final String redirectId;  
  
    public KakaoOAuth2Client(  
        @Value("${festago.oauth2.kakao.grant-type}") String grantType,  
        @Value("${festago.oauth2.kakao.client-id}") String clientId,  
        @Value("${festago.oauth2.kakao.redirect-uri}") String redirectUri,  
        RestTemplateBuilder restTemplateBuilder  
    ) {  
        this.grantType = grantType;  
        this.clientId = clientId;  
        this.redirectId = redirectUri;  
        this.restTemplate = restTemplateBuilder.build();  
    }  
  
    public String getAccessToken(String code) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.add("grant_type", grantType);  
        headers.add("client_id", clientId);  
        headers.add("redirect_uri", redirectId);  
        headers.add("code", code);  
  
        try {  
            KakaoAccessTokenResponse response = restTemplate.postForEntity(  
                ACCESS_TOKEN_URL, headers,  
                KakaoAccessTokenResponse.class).getBody();  
            return response.accessToken();  
        } catch (HttpClientErrorException e) {  
            KakaoOAuth2Error kakaoOAuth2Error = e.getResponseBodyAs(KakaoOAuth2Error.class);  
            if (kakaoOAuth2Error.isErrorCodeKOE320()) {  
                throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  
            }  
            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  
        }  
    }  
  
    public UserInfo getUserInfo(String accessToken) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.setBearerAuth(accessToken);  
  
        try {  
            KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  
                    KakaoUserInfo.class)  
                .getBody();  
            return UserInfo.ofKakao(kakaoUserInfo);  
        } catch (HttpClientErrorException e) {  
            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  
        }  
    }  
  
    public record KakaoOAuth2Error(  
        String error,  
        @JsonProperty("error_description") String errorDescription,  
        @JsonProperty("error_code") String errorCode  
    ) {  
  
        public boolean isErrorCodeKOE320() {  
            return errorCode.equals("KOE320");  
        }  
    }  
}
```

ì‹¤ì œ ì¹´ì¹´ì˜¤ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìì—ê²Œ ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” `KakaoOAuth2Client` ì…ë‹ˆë‹¤.

ì½”ë“œì— ì§€ì €ë¶„í•œ ê³³ì´ ë§ê³ , ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€í‚¤ì§€ ì•ŠëŠ” ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. (ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­, ì‚¬ìš©ì ì •ë³´ ìš”ì²­)

ì¶”í›„ ì´ ë¶€ë¶„ì„ ì–´ë–»ê²Œ ê°œì„ í–ˆëŠ”ì§€ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

> recordì— @JsonPropertyë¥¼ ì‚¬ìš©í•œ ì´ìœ ëŠ” [ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš° ë§í¬](https://stackoverflow.com/questions/68394911/why-record-class-cant-be-properly-deserialized-with-jackson)ì— ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤.

#### AuthService
```java
@Service
@Transactional
public class AuthService {  
  
    private final MemberRepository memberRepository;  
    private final OAuth2Client oAuth2Client;  
    private final AuthProvider authProvider;  
  
    public AuthService(MemberRepository memberRepository, OAuth2Client oAuth2Client, AuthProvider authProvider) {  
        this.memberRepository = memberRepository;  
        this.oAuth2Client = oAuth2Client;  
        this.authProvider = authProvider;  
    }  
  
    public LoginResponse login(String code) {  
        String accessToken = oAuth2Client.getAccessToken(code);  
        UserInfo userInfo = oAuth2Client.getUserInfo(accessToken);  
        Member member = memberRepository.findBySocialIdAndSocialType(userInfo.socialId(), userInfo.socialType())  
            .orElseGet(() -> memberRepository.save(userInfo.toMember()));  
        return new LoginResponse(authProvider.provide(member), userInfo.nickname());  
    }  
}
```

ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë³´ë‚´ì˜¨ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

íë¦„ì€ ë§¨ ìœ„ì—ì„œ ì„¤ëª…í•œ ê²ƒê³¼ ê°™ì´ ì½”ë“œë¥¼ ë°›ì•„, OAuth2 ì„œë¹„ìŠ¤ ì œê³µìë¡œë¶€í„° ì•¡ì„¸ìŠ¤ í† í°ì„ ì–»ê³ , ì‚¬ìš©ì ì •ë³´ë¥¼ ì–»ì€ ë’¤ ê¸°ì¡´ì˜ íšŒì›ì´ ìˆìœ¼ë©´ `AuthProvider`ë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜í•˜ê³ , ê¸°ì¡´ì˜ íšŒì›ì´ ì—†ë‹¤ë©´ `orElseGet()` ë©”ì„œë“œë¥¼ í†µí•´ íšŒì›ì„ ìƒì„±í•˜ê³  ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

---

ì´ë ‡ê²Œ êµ¬í˜„í•œ ë°©ì‹ì—ëŠ” ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤.

`OAuth2Client`ì˜ ì½”ë“œë¥¼ ë³´ë©´ ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€í‚¤ì§€ ëª»í–ˆê³ (ì•¡ì„¸ìŠ¤ ì½”ë“œì™€ ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‘ ê´€ë¦¬) ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ try-catchë¬¸ ë•Œë¬¸ì— ì½”ë“œì˜ ê°€ë…ì„±ì´ ë‚˜ì©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  `OAuth2Client`ë¥¼ ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜í•˜ì—¬ ë³€ê²½ì—ëŠ” ìœ ì—°í•˜ê²Œ ëŒ€ì‘í–ˆì§€ë§Œ, ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ì¶”ê°€ë  ê²½ìš° ìƒˆë¡œìš´ í´ë˜ìŠ¤ í˜¹ì€ ë©”ì†Œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.

### ë‹¨ì¼ ì±…ì„ ì›ì¹™ì˜ ë¶„ë¦¬

ìœ ëª…í•œ ê°ì²´ ì§€í–¥ ì›ì¹™ì¸ SOLID ì›ì¹™ì—ì„œ SëŠ” ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ëœ»í•©ë‹ˆë‹¤.

ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ë©°, ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•œ OCP, DIP ì›ì¹™ì€ ë§¤ìš° ì‰½ê²Œ ì§€í‚¬ ìˆ˜ ìˆìœ¼ë‚˜, SRP ì›ì¹™ì€ êµ¬í˜„í•˜ëŠ” ê°œë°œìê°€ ê°ì²´ê°€ ê°€ì§€ëŠ” ì±…ì„ì„ ì–¼ë§ˆë‚˜ ì˜ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ”ì§€ì— ë”°ë¼ ë‹¬ë ¸ìŠµë‹ˆë‹¤.

OAuth2ClientëŠ” ë‘ ê°€ì§€ ì¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
1. ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­
2. ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­

ë‘ ê°€ì§€ ì¼ì€ OAuth2 ì¸ì¦ì˜ íë¦„ìœ¼ë¡œëŠ” í•˜ë‚˜ì˜ ì‘ì—…ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆê² ì§€ë§Œ ê°ì²´ê°€ ê°€ì§€ëŠ” ì±…ì„ì€ ë‘ ê°€ì§€ ì±…ì„ì„ ì§€ê³  ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ, ì—‘ì„¸ìŠ¤ í† í°ë§Œ ìš”ì²­í•˜ëŠ” í´ë˜ìŠ¤ì™€ ì‚¬ìš©ì ì •ë³´ë§Œ ìš”ì²­í•˜ëŠ” í´ë˜ìŠ¤ë¡œ ë‚˜ëˆ  ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### KakaoOAuth2AccessTokenClient
```java
@Component
public class KakaoOAuth2AccessTokenClient {  
  
    private static final String URL = "https://kauth.kakao.com/oauth/token";  
  
    private final RestTemplate restTemplate;  
    private final String grantType;  
    private final String clientId;  
    private final String redirectUri;  
  
    public KakaoOAuth2AccessTokenClient(  
        @Value("${festago.oauth2.kakao.grant-type}") String grantType,  
        @Value("${festago.oauth2.kakao.client-id}") String clientId,  
        @Value("${festago.oauth2.kakao.redirect-uri}") String redirectUri,
        @Value("${festago.oauth2.kakao.client-secret}") String clientSecret,  
        RestTemplateBuilder restTemplateBuilder  
    ) {  
        this.grantType = grantType;  
        this.clientId = clientId;  
        this.redirectUri = redirectUri;  
        this.clientSecret = clientSecret;
        this.restTemplate = restTemplateBuilder.build();  
    }  
  
    public String getAccessToken(String code) {  
        HttpHeaders headers = getAccessTokenHeaders(code);  
        return requestAccessToken(headers);  
    }  
  
    private HttpHeaders getAccessTokenHeaders(String code) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.set("grant_type", grantType);  
        headers.set("client_id", clientId);  
        headers.set("redirect_uri", redirectUri);  
        headers.set("client_secret", clientSecret);
        headers.set("code", code);  
        return headers;  
    }  
  
    private String requestAccessToken(HttpHeaders headers) {  
        try {  
            KakaoAccessTokenResponse response = restTemplate.postForEntity(ACCESS_TOKEN_URL, headers,  
                KakaoAccessTokenResponse.class).getBody();  
            return response.accessToken();  
        } catch (HttpClientErrorException e) {  
            KakaoOAuth2Error kakaoOAuth2Error = e.getResponseBodyAs(KakaoOAuth2Error.class);  
            if (kakaoOAuth2Error.isErrorCodeKOE320()) {  
                throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  
            }  
            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  
        }  
    }
}
```

#### KakaoOAuth2UserInfoClient
```java
@Component
public class KakaoOAuth2UserInfoClient {  
  
    private static final String URL = "https://kapi.kakao.com/v2/user/me";  
  
    private final RestTemplate restTemplate;  
  
    public KakaoOAuth2UserInfoClient(RestTemplateBuilder restTemplateBuilder) {  
        this.restTemplate = restTemplateBuilder.build();  
    }  
  
    public UserInfo getUserInfo(String accessToken) {  
        HttpHeaders headers = getUserInfoHeaders(accessToken);  
        return requestUserInfo(headers);  
    }  
  
    private HttpHeaders getUserInfoHeaders(String accessToken) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.setBearerAuth(accessToken);  
        return headers;  
    }  
  
    private UserInfo requestUserInfo(HttpHeaders headers) {  
        try {  
            KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  
                    KakaoUserInfo.class)  
                .getBody();  
            return kakaoUserInfo.toUserInfo();  
        } catch (HttpClientErrorException e) {  
            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  
        }
    }
}
```

ê·¸ë¦¬ê³  ê¸°ì¡´ì˜ `KakaoOAuth2Client`ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@Component  
public class KakaoOAuth2Client implements OAuth2Client {

    private final KakaoOAuth2AccessTokenClient accessTokenClient;  
    private final KakaoOAuth2UserInfoClient userInfoClient;
    
    public KakaoOAuth2Client(KakaoOAuth2AccessTokenClient accessTokenClient, KakaoOAuth2UserInfoClient userInfoClient) {  
        this.accessTokenClient = accessTokenClient;  
        this.userInfoClient = userInfoClient;  
    }

    public String getAccessToken(String code) {  
        return accessTokenClient.getAccessToken(code)
    }  
  
    public UserInfo getUserInfo(String accessToken) {  
        return userInfoClient.getUserInfo(accessToken);
    }  
}
```

ì´ì œë¶€í„° `KakaoOAuth2Client` í´ë˜ìŠ¤ëŠ” ì±…ì„ì„ ë¶„ë¦¬í•œ í´ë˜ìŠ¤ì— ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

#### ResponseErrorHandler

í•˜ì§€ë§Œ ì•„ì§ë„ ì—¬ì „íˆ ì¶”í•œ try-catchê°€ ì½”ë“œì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.

`RestTemplate` í´ë˜ìŠ¤ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì–´ì©” ìˆ˜ ì—†ì´ try-catchë¬¸ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ì ê¹,

ì €í¬ëŠ” ìŠ¤í”„ë§ì„ ì‚¬ìš©í•˜ë©° ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤ ë ˆì´ì–´ì— try-catchë¥¼ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì˜¤íˆë ¤ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë˜ì ¸ë²„ë¦½ë‹ˆë‹¤.

ê·¸ëŸ¬ëŠ” ì´ìœ ëŠ” ìš”ì²­ì˜ ì˜ˆì™¸ë¥¼ ì „ì—­ì ìœ¼ë¡œ ì²˜ë¦¬í•´ ì£¼ëŠ” `@ControllerAdvice`ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

`RestTemplate` í´ë˜ìŠ¤ì—ì„œë„ `@ControllerAdvice` ê°™ì€ ì—­í• ì„ í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤.

ë°”ë¡œ `ResponseErrorHandler` ì…ë‹ˆë‹¤.

`ResponseErrorHandler`ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë‘ ê°œì˜ ì¶”ìƒ ë©”ì†Œë“œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

```java
public interface ResponseErrorHandler {

    boolean hasError(ClientHttpResponse response) throws IOException;
    
    void handleError(ClientHttpResponse response) throws IOException;
}
```

ì‚¬ì‹¤ ì´ë¯¸ `RestTemplate`ì—ì„œëŠ” ê¸°ë³¸ì ì¸ `ResponseErrorHandler`ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```java
public class RestTemplate extends InterceptingHttpAccessor implements RestOperations {
    ...
    private ResponseErrorHandler errorHandler = new DefaultResponseErrorHandler();
    ...
}
```

ë”°ë¼ì„œ ê¸°ì¡´ì˜ `ResponseErrorHandler`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì»¤ìŠ¤í…€í•œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ë©´ ì˜ˆì™¸ ì²˜ë¦¬ì— ê´€í•œ ë¡œì§ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#### KakaoOAuth2AccessTokenErrorHandler
```java
public class KakaoOAuth2AccessTokenErrorHandler extends DefaultResponseErrorHandler {  
  
    @Override  
    public void handleError(ClientHttpResponse response) throws IOException {  
        try {  
            super.handleError(response);  
        } catch (HttpStatusCodeException e) {  
            HttpStatusCode statusCode = response.getStatusCode();  
            handle4xxError(statusCode, e);  
            handle5xxError(statusCode);  
        }  
        throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR);  
    }  
  
    private void handle4xxError(HttpStatusCode statusCode, HttpStatusCodeException e) {  
        if (statusCode.is4xxClientError()) {  
            KakaoOAuth2ErrorResponse errorResponse = e.getResponseBodyAs(KakaoOAuth2ErrorResponse.class);  
            handleErrorCode(errorResponse);  
        }  
    }  
  
    private void handleErrorCode(KakaoOAuth2ErrorResponse errorResponse) {  
        handleKOE320Error(errorResponse);  
        throw new InternalServerException(ErrorCode.OAUTH2_INVALID_REQUEST);  
    }  
  
    private void handleKOE320Error(KakaoOAuth2ErrorResponse errorResponse) {  
        if (errorResponse != null && errorResponse.isErrorCodeKOE320()) {  
            throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  
        }  
    }  
  
    private void handle5xxError(HttpStatusCode statusCode) {  
        if (statusCode.is5xxServerError()) {  
            throw new InternalServerException(ErrorCode.OAUTH2_PROVIDER_NOT_RESPONSE);  
        }  
    }  
  
    public record KakaoOAuth2ErrorResponse(  
        String error,  
        @JsonProperty("error_description") String errorDescription,  
        @JsonProperty("error_code") String errorCode  
    ) {  
  
        public boolean isErrorCodeKOE320() {  
            return Objects.equals(errorCode, "KOE320");  
        }  
    }  
}
```

#### KakaoOAuth2UserInfoErrorHandler
```java
public class KakaoOAuth2UserInfoErrorHandler extends DefaultResponseErrorHandler {  
  
    @Override  
    public void handleError(ClientHttpResponse response) throws IOException {  
        HttpStatusCode statusCode = response.getStatusCode();  
        handle4xxError(statusCode);  
        handle5xxError(statusCode);  
        throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR);  
    }  
  
    private void handle4xxError(HttpStatusCode statusCode) {  
        if (statusCode.is4xxClientError()) {  
            throw new InternalServerException(ErrorCode.OAUTH2_INVALID_REQUEST);  
        }  
    }  
  
    private void handle5xxError(HttpStatusCode statusCode) {  
        if (statusCode.is5xxServerError()) {  
            throw new InternalServerException(ErrorCode.OAUTH2_PROVIDER_NOT_RESPONSE);  
        }  
    }  
}
```

í•´ë‹¹ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¥¼ ì ìš©í•œ OAuth2ClientëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œê°€ ë³€ê²½ë©ë‹ˆë‹¤.
#### KakaoOAuth2AccessTokenClient
```java
@Component
public class KakaoOAuth2AccessTokenClient {  
  
    private static final String URL = "https://kauth.kakao.com/oauth/token";  
  
    private final RestTemplate restTemplate;  
    private final String grantType;  
    private final String clientId;  
    private final String redirectUri;  
  
    public KakaoOAuth2AccessTokenClient(  
        @Value("${festago.oauth2.kakao.grant-type}") String grantType,  
        @Value("${festago.oauth2.kakao.client-id}") String clientId,  
        @Value("${festago.oauth2.kakao.redirect-uri}") String redirectUri,
        @Value("${festago.oauth2.kakao.client-secret}") String clientSecret,  
        RestTemplateBuilder restTemplateBuilder  
    ) {  
        this.grantType = grantType;  
        this.clientId = clientId;  
        this.redirectUri = redirectUri;  
        this.clientSecret = clientSecret;
        this.restTemplate = restTemplateBuilder
            .errorHandler(new KakaoOAuth2AccessTokenErrorHandler())
            .build();  
    }  
  
    public String getAccessToken(String code) {  
        HttpHeaders headers = getAccessTokenHeaders(code);  
        return requestAccessToken(headers);  
    }  
  
    private HttpHeaders getAccessTokenHeaders(String code) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.set("grant_type", grantType);  
        headers.set("client_id", clientId);  
        headers.set("redirect_uri", redirectUri);  
        headers.set("client_secret", clientSecret);
        headers.set("code", code);  
        return headers;  
    }  
  
    private String requestAccessToken(HttpHeaders headers) {  
        KakaoAccessTokenResponse response = restTemplate.postForEntity(ACCESS_TOKEN_URL, headers,  
            KakaoAccessTokenResponse.class).getBody();  
        return response.accessToken();  
    }
}
```

#### KakaoOAuth2UserInfoClient
```java
@Component
public class KakaoOAuth2UserInfoClient {  
  
    private static final String URL = "https://kapi.kakao.com/v2/user/me";  
  
    private final RestTemplate restTemplate;  
  
    public KakaoOAuth2UserInfoClient(RestTemplateBuilder restTemplateBuilder) {  
        this.restTemplate = restTemplateBuilder
            .errorHandler(new KakaoOAuth2UserInfoErrorHandler())
            .build();  
    }  
  
    public UserInfo getUserInfo(String accessToken) {  
        HttpHeaders headers = getUserInfoHeaders(accessToken);  
        return requestUserInfo(headers);  
    }  
  
    private HttpHeaders getUserInfoHeaders(String accessToken) {  
        HttpHeaders headers = new HttpHeaders();  
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  
        headers.setBearerAuth(accessToken);  
        return headers;  
    }  
  
    private UserInfo requestUserInfo(HttpHeaders headers) {  
        KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  
                KakaoUserInfo.class)  
            .getBody();  
        return kakaoUserInfo.toUserInfo();  
    }
}
```

ì´ì²˜ëŸ¼ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì±…ì„ì„ ê°€ì§„ ê°ì²´ë¡œ ë¶„ë¦¬í•˜ì—¬, ìš”ì²­ì„ ë³´ë‚´ëŠ” ê°ì²´ì—ëŠ” ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œ í•˜ë‚˜ ì—†ì´ ì˜¤ë¡œì§€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê²Œ ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ìƒˆë¡œìš´ OAuth2 í´ë¼ì´ì–¸íŠ¸ì˜ ì¶”ê°€

ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” `OAuth2Client`ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

ì¸í„°í˜ì´ìŠ¤ë¡œ ì„¤ê³„í•˜ì—¬, OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ë°”ë€Œë”ë¼ë„ ì‰½ê²Œ êµì²´í•  ìˆ˜ ìˆê³ , ëª¨ì˜ OAuth2Client ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì™¸ë¶€ APIì˜ ì—°ë™ ì—†ì´ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì´ë ‡ê²Œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë§Œë“¤ì–´ë„, ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œê°€ í•˜ë‚˜ì´ê¸° ë•Œë¬¸ì— ì¶”ê°€ì ì¸ OAuth2Clientë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ ì œê³µìë§ˆë‹¤ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê±°ë‚˜, í•„ë“œì™€ ë©”ì†Œë“œê°€ ìƒê¸¸ ê²ƒì…ë‹ˆë‹¤.

```java
public class KakaoOAuth2Service{
    ...
};

public class NaverOAuth2Service{
    ...
};

// ë˜ëŠ”

public class AuthService {

    private final OAuth2Client kakaoOAuth2Client;
    private final OAuth2Client naverOAuth2Client;
    
    public void loginKakaoOAuth2(String code) {
        ...
    }
    public void loginKakaoOAuth2(String code) {
        ...
    }
}
```

ì´ê²ƒì€ ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€ì¼°ë‹¤ê³  í•  ìˆ˜ ìˆê² ì§€ë§Œ, ì¤‘ë³µëœ ì½”ë“œê°€ ìƒê¸°ê²Œ ë˜ê³  ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì œê³µìê°€ ìƒê¸¸ ë•Œ ìƒˆë¡œìš´ ë©”ì†Œë“œë¥¼ ì¶”ê°€í•´ ì¤˜ì•¼ í•©ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ì˜ í•„ë“œë¡œ ì—¬ëŸ¬ `OAuth2Client`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?

ìŠ¤í”„ë§ì€ ì˜ì¡´ì„±ì„ ì£¼ì…í•  ë•Œ ì»¬ë ‰ì…˜ìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì£¼ì…í•´ ì£¼ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì—¬ëŸ¬ `OAuth2Client`ë¥¼ `List` í˜•ì‹ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public class AuthService {

    private final List<OAuth2Client> oAuth2Clients;

    public AuthService(List<OAuth2Client> oAuth2Clients) {
        this.oAuth2Clients = oAuth2Clients;
    }
}
```

ì´ê²ƒì´ ë°”ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì˜ì¡´í•˜ê²Œ í•˜ë©´ ì–»ì„ ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ì´ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.

ê·¸ëŸ°ë°, ë‹¨ìˆœíˆ List íƒ€ì…ìœ¼ë¡œ ë°›ì•˜ë‹¤ê³  í•´ì„œ ëë‚˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.

ë¦¬ìŠ¤íŠ¸ ì¤‘ì—ì„œ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì„ íƒí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

```java
public OAuth2Client getClient(SocialType socialType) {
    return oAuth2Clients.stream()
        .filter(client -> client.getSocialType == socialType)
        .findAny()
        .orElseThrow(() -> BadRequestException(...));
}
```

ì´ë ‡ê²Œ Streamì„ í™œìš©í•´ì„œ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì„ íƒí•  ìˆ˜ ìˆê² ì§€ë§Œ, ë§¤ë²ˆ Streamì„ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì°¾ëŠ” ì‘ì—…ì€ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.

ì´ë•ŒëŠ” List ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒ ë³´ë‹¤ Map ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©´ íš¨ìœ¨ì ì¼ ê²ƒì…ë‹ˆë‹¤.

ìŠ¤í”„ë§ì€ Map íƒ€ì…ìœ¼ë¡œë„ ì˜ì¡´ì„± ì£¼ì…ì„ ì œê³µí•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ Mapìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ìœ¼ë©´ Keyê°€ Stringì¸ `kakaoOAuth2Client`ì™€ ê°™ì´ ì§€ì •ë©ë‹ˆë‹¤.

```java
private final Map<String, OAuth2Client> oAuth2ClientMap;
```

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì˜ì¡´ì„± ì£¼ì…ì€ Listë¡œ ë°›ì€ ë’¤, ë‚´ë¶€ì—ì„œ Mapìœ¼ë¡œ ë³€í™˜ì‹œí‚¤ë©´ Keyê°€ Enum íƒ€ì…ì¸ Mapì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
private final Map<SocialType, OAuth2Client> oAuth2ClientMap = new EnumMap<>(SocialType.class);

public AuthService(List<OAuth2Client> oAuth2Clients) {
    for (OAuth2Client oAuth2Client: oAuth2Clients) {
        oAuth2ClientMap.put(oAuth2Client.getSocialType(), oAuth2Client);
    }
}
```

ì´ì œ ë‹¤ìŒê³¼ ê°™ì´ íŠ¹ì • í´ë¼ì´ì–¸íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public OAuth2Clients getOAuth2Client(SocialType socialType) {
    return Optional.ofNullable(oAuth2ClientMap.get(socialType))  
        .orElseThrow(() -> new BadRequestException(...));
}
```

í•˜ì§€ë§Œ ì´ê²ƒ ë˜í•œ ì™„ë²½í•˜ê²Œ í•´ê²°í•œ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.

í•„ë“œì— `OAuth2Client`ì— ëŒ€í•œ ìë£Œêµ¬ì¡°ê°€ ê·¸ëŒ€ë¡œ ë…¸ì¶œì´ ë˜ê³  ìˆìŠµë‹ˆë‹¤.

`AuthService` í´ë˜ìŠ¤ì—ì„œ í•„ìš”í•œ ê¸°ëŠ¥ì€ SocialTypeì— ë§ëŠ” OAuth2Clientë§Œ ì„ íƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

`AuthService` í´ë˜ìŠ¤ëŠ” Mapì— ëŒ€í•œ ê¸°ëŠ¥ì„ ìì„¸íˆ ì•Œ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.

ì´ê²ƒì€ ì €í¬ê°€ ë ˆë²¨1ë¶€í„° ë°°ì›Œì˜¨ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë°”ë¡œ `ì¼ê¸‰ ì»¬ë ‰ì…˜`ìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.

```java
@Component
public class OAuth2Clients {
    private final Map<SocialType, OAuth2Client> oAuth2ClientMap = new EnumMap<>(SocialType.class);

    public OAuth2Clients(List<OAuth2Client> oAuth2Clients) {
        for (OAuth2Client oAuth2Client: oAuth2Clients) {
            oAuth2ClientMap.put(oAuth2Client.getSocialType(), oAuth2Client);
        }
    }

    public OAuth2Client getClient(SocialType socialType) {
        return Optional.ofNullable(oAuth2ClientMap.get(socialType))  
            .orElseThrow(() -> new BadRequestException(...));
    }
}
```

ê·¸ë¦¬ê³  `AuthService`ì˜ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³€í•©ë‹ˆë‹¤.

```java
@Service
@Transactional
public class AuthService {
    private final OAuth2Clients oAuth2Clients;

    ...

    public LoginResponse login(SocialType socialType, String code) {  
        OAuth2Client oAuth2Client = oAuth2Clients.getClient(socialType);
        String accessToken = oAuth2Client.getAccessToken(code);  
        UserInfo userInfo = oAuth2Client.getUserInfo(accessToken);  
        Member member = memberRepository.findBySocialIdAndSocialType(userInfo.socialId(), socialType)  
            .orElseGet(() -> memberRepository.save(userInfo.toMember()));  
        return new LoginResponse(authProvider.provide(member), userInfo.nickname());  
    }  
} 
```

ì´ì œ ìƒˆë¡œìš´ OAuth2Clientê°€ ì¶”ê°€ë˜ì–´ë„ ê¸°ì¡´ì˜ ì½”ë“œë¥¼ ë³€ê²½í•  í•„ìš”ëŠ” ì „í˜€ ì—†ì–´ì§‘ë‹ˆë‹¤.

ë˜í•œ ë¡œì»¬ í™˜ê²½ ë˜ëŠ” í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•œ ëª¨ì˜ OAuth2Clientë¥¼ ë§Œë“¤ë”ë¼ë„ `@Profile`  ì–´ë…¸í…Œì´ì…˜ì˜ ì‚¬ìš©ìœ¼ë¡œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì „í˜€ ì˜í–¥ì„ ì£¼ì§€ ì•Šê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@Component  
@Profile("!prod")  
public class FestagoOAuth2Client implements OAuth2Client {  
  
    private static final String PROFILE_IMAGE = "https://placehold.co/150x150";  
  
    private final Map<String, UserInfo> userInfoMap = new HashMap<>();  
  
    public FestagoOAuth2Client() {  
        userInfoMap.put("1", new UserInfo("1", getSocialType(), "member1", PROFILE_IMAGE));  
        userInfoMap.put("2", new UserInfo("2", getSocialType(), "member2", PROFILE_IMAGE));  
        userInfoMap.put("3", new UserInfo("3", getSocialType(), "member3", PROFILE_IMAGE));  
    }  
  
    @Override  
    public UserInfo getUserInfo(String accessToken) {  
        return Optional.ofNullable(userInfoMap.get(accessToken))
            .orElseThrow(() -> new BadRequestException(...));
    }  
  
    @Override  
    public SocialType getSocialType() {  
        return SocialType.FESTAGO;  
    }  
}
```

## ê²°ë¡ 

OAuth2ë¥¼ ì‚¬ìš©í•œ ì¸ì¦ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ë•Œ, ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì˜ì¡´ì„± ì£¼ì… ê¸°ëŠ¥ê³¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œ ë‹¤í˜•ì„± í™œìš© ë“±, ê°ì²´ ì§€í–¥ ì„¤ê³„ë¥¼ ë”°ë¼ ì½”ë“œë¥¼ êµ¬í˜„í•˜ë©´ ë³€ê²½ì— ìœ ì—°í•˜ê³  ê°€ë…ì„±ì´ ë†’ì€ ì½”ë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì €í¬ ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ ìƒˆë¡œìš´ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ì¶”ê°€ë  í™•ë¥ ì€ ë‚®ê² ì§€ë§Œ, ë ˆë²¨ 1, 2 ê³¼ì •ì„ ë°°ìš°ë©° ìŠµë“í•œ ê°ì²´ ì§€í–¥ ì„¤ê³„ ì›ì¹™ì„ ì´ë ‡ê²Œ ì„œë¹„ìŠ¤ì— ë…¹ì—¬ëƒˆë‹¤ëŠ” ì ì´ ë¿Œë“¯í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.


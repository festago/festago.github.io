---
title: "í˜ìŠ¤íƒ€ê³ ì˜ ì¸ì¦ - ì—¬ëŸ¬ ì‚¬ìš©ìì˜ ì¸ì¦ê³¼ ì¸ê°€"
description: "í˜ìŠ¤íƒ€ê³ ì—ì„œ ì—¬ëŸ¬ ì‚¬ìš©ìì˜ ì¸ì¦ê³¼ ì¸ê°€ë¥¼ ì–´ë–»ê²Œ êµ¬í˜„í–ˆëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤."
date: 2023-08-24
update: 2023-08-24
tags:
- OAuth2
---

## ì„œë¡ 

ì•ˆë…•í•˜ì„¸ìš”.

í˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ

í˜ìŠ¤íƒ€ê³ ì—ëŠ” ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ ì‚¬ìš©ìì˜ ì—­í• ì— ë§ëŠ” ì¸ì¦ê³¼ ì¸ê°€ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤.

ë‹¨ìˆœíˆ ì—­í• ì— ë”°ë¥¸ êµ¬ë¶„ì´ë¼ë©´ í° ë¬¸ì œê°€ ì—†ê² ì§€ë§Œ, ë‹¤ì–‘í•œ ì‚¬ìš©ìë“¤ì´ ì ‘ì†í•˜ëŠ” í™˜ê²½ì—ì„œ ì¸ì¦ì„ í•˜ëŠ” ë°©ë²•ì—ì„œ ì°¨ì´ë¡œ ì¸í•´ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ì–´ë– í•œ ë¬¸ì œì ì— ì§ë©´í–ˆê³ , ì´ê²ƒì„ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.
## ë³¸ë¡ 

í˜ìŠ¤íƒ€ê³ ëŠ” ì¶•ì œì˜ ê³µì—°ì— ëŒ€í•œ í‹°ì¼“íŒ…ì„ ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì˜¨ë¼ì¸ìœ¼ë¡œ í¸í•˜ê²Œ ì˜ˆë§¤í•˜ê³  ë¹ ë¥´ê²Œ ì¶œì…ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.

ì ê¹ ì €í¬ ì„œë¹„ìŠ¤ì˜ íë¦„ì— ê´€í•´ ì´ì•¼ê¸°ë¥¼ í•´ë³´ê² ìŠµë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ê³µì—°ì— ëŒ€í•´ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

ì´ë•Œ, ì‚¬ìš©ìê°€ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ë ¤ë©´ ìš°ì„  ê³µì—°ê³¼ ì¶•ì œê°€ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ê³µì—°ê³¼ ì¶•ì œëŠ” í‹°ì¼“ì„ ì˜ˆë§¤í•˜ëŠ” ì‚¬ìš©ìê°€ ìƒì„±ì„ í•˜ëŠ” ê²ƒì¼ê¹Œìš”?

ê³µì—°ê³¼ ì¶•ì œë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ëŠ” ì‚¬ìš©ìê°€ ì•„ë‹Œ, ì¶•ì œì™€ ê³µì—°ì„ ê°œìµœí•˜ê³  ì‹¶ì€ ê´€ë¦¬ìì…ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì˜ˆë§¤í•œ í‹°ì¼“ì„ ê²€ì‚¬í•  ë•Œë„ ë§ˆì°¬ê°€ì§€ë¡œ, í‹°ì¼“ì„ ê²€ì‚¬í•˜ëŠ” ì‚¬ìš©ìê°€ ìˆìŠµë‹ˆë‹¤.

í‹°ì¼“ì„ ê²€ì‚¬í•˜ëŠ” ì‚¬ìš©ìëŠ” ê³µì—°ê³¼ ì¶•ì œë¥¼ ìƒì„±í•˜ëŠ” ê´€ë¦¬ìê°€ ì•„ë‹Œ, ê´€ë¦¬ìì— ì˜í•´ ê³ ìš©ëœ ìŠ¤íƒœí”„ì¼ ê²ƒì…ë‹ˆë‹¤.

ì´ì²˜ëŸ¼ í˜ìŠ¤íƒ€ê³ ì—ëŠ” ì—­í• ë³„ë¡œ ì±…ì„ì´ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

> í‹°ì¼“ì„ ì˜ˆë§¤í•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Member
> 
> ì¶•ì œì™€ ê³µì—°ì„ ê³„íší•˜ê³  ê°œìµœí•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Admin
> 
> í‹°ì¼“ì„ ê²€ì‚¬í•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Staff

ì´ë ‡ë“¯ ì‚¬ìš©ìë“¤ì€ ê°ìì˜ ì—­í• ê³¼ ì±…ì„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ì–´ë–»ê²Œ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆì„ê¹Œìš”?

ì €í¬ ì„œë¹„ìŠ¤ëŠ” JWT í† í°ì„ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ë‹ˆ JWT í† í°ì— ë‹¤ìŒê³¼ ê°™ì€ ê°’ì„ ë„£ì„ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```json
{
    "id": 1,
    "role": "MEMBER"
}

{
    "id": 2,
    "role": "STAFF"
}

{
    "id": 3,
    "role": "ADMIN"
}
```

ì´ë ‡ê²Œ í† í°ì— `role` í•„ë“œë¥¼ ì¶”ê°€í•˜ë©´ ì‚¬ìš©ìì˜ ì—­í• ì„ ì‰½ê²Œ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

ê° ì—­í• ì˜ ì‚¬ìš©ìë“¤ì€ ì ‘ì†í•˜ëŠ” í™˜ê²½ì´ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì¼ë°˜ ì‚¬ìš©ìì™€ ìŠ¤íƒœí”„ëŠ” ëª¨ë°”ì¼ ì•± í™˜ê²½ì—ì„œ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ê´€ë¦¬ìëŠ” ëª¨ë°”ì¼ ì•±ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì›¹ í˜ì´ì§€ë¥¼ í†µí•´ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.

ê´€ë¦¬ìê°€ ì ‘ì†í•˜ëŠ” í™˜ê²½ì—ì„œëŠ” ì „ìš© ì•±ì„ ì œì‘í•  í•„ìš”ê°€ ì—†ê³  ê°„ë‹¨í•œ ì›¹ í˜ì´ì§€ë§Œ ìˆìœ¼ë©´ ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì´ê²ƒì´ ì™œ ë¬¸ì œê°€ ë˜ëŠ” ê±¸ê¹Œìš”?

ëª¨ë°”ì¼ ì•± í™˜ê²½ì—ì„œ ìš”ì²­ì„ ë³´ë‚¼ ë•ŒëŠ” JWT í† í°ì„ HTTP í—¤ë”ì— ë‹´ì•„ ìš”ì²­í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ì›¹ í˜ì´ì§€ í™˜ê²½ì—ì„œëŠ” JWT í† í°ì„ ì¿ í‚¤ì— ë‹´ì•„ ìš”ì²­í•©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ì‚¬ìš©ìì˜ í™˜ê²½ë§ˆë‹¤ í† í°ì„ ë³´ë‚´ëŠ” ë°©ë²•ì´ ë‹¤ë¥´ë‹ˆ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì´ëŸ° ìƒê°ì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> "ì›¹ í˜ì´ì§€ì—ì„œë„ í—¤ë”ì— í† í°ì„ ë‹´ì•„ì„œ ë³´ë‚´ë©´ ì•ˆë˜ë‚˜ìš”?"

ì›¹ í˜ì´ì§€ë¥¼ í†µí•´ í† í°ì„ í—¤ë”ì— ë‹´ì•„ ìš”ì²­ì„ í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

ë‹¨ìˆœí•˜ê²Œ í† í°ì„ í—¤ë”ì— ë‹´ì•„ ìš”ì²­í•˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ë¡œê·¸ì¸ì„ í†µí•´ tokenì„ ì„œë²„ì—ì„œ ì–»ëŠ”ë‹¤.
2. tokenì„ ì–´ë”˜ê°€ì— ì €ì¥í•œë‹¤.
3. ìš”ì²­ë§ˆë‹¤ ì €ì¥í•œ í† í°ì„ í—¤ë”ì— ì¶”ê°€í•˜ì—¬ ì„œë²„ì— ì „ì†¡í•œë‹¤.

ì—¬ê¸°ì„œ tokenì„ ì–´ë”˜ê°€ì— ì €ì¥í•´ì•¼ í•˜ëŠ”ë°, ì €ì¥í•  ì¥ì†ŒëŠ” `LocalStorage` ë˜ëŠ” `SessionStorage`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì´ `Authorization` í—¤ë”ë¥¼ ì¶”ê°€í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.

```js
const credentials = localStorage.getItem('credentials');
fetch("/admin/function", {  
  method: "POST",  
  headers: {  
    "Authorization": `Bearer ${credentials}`,
    "Content-Type": "application/json"  
  },  
  body: JSON.stringify(...)  
})
```

ì½”ë“œë§Œ ë³¸ë‹¤ë©´ ì €ì¥ëœ í† í°ì„ êº¼ë‚´ëŠ” ì‘ì—…ê³¼ í—¤ë”ì— í† í°ì„ ì¶”ê°€í•˜ëŠ” ì‘ì—… ì™¸ì—ëŠ” ì „í˜€ ë¬¸ì œê°€ ë  ìƒí™©ì´ë¼ê³  ë³´ì´ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ë³´ì•ˆ ì¸¡ë©´ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

LocalStorage ê°™ì€ ì €ì¥ì†Œì— ìˆëŠ” ê°’ë“¤ì€ XSS ê³µê²©ì— ì·¨ì•½í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ì €í¬ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µëœ í† í°ì„ ì‰½ê²Œ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
localStorage.getItem('credentials');
```

í•˜ì§€ë§Œ ì¿ í‚¤ ë˜í•œ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ì‰½ê²Œ XSS ê³µê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì€ í•œ ì¤„ë¡œ ì¿ í‚¤ì˜ ëª©ë¡ì„ ì „ë¶€ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
document.cookie;
```

í•˜ì§€ë§Œ ì¿ í‚¤ì˜ ê²½ìš° `HttpOnly`ë¼ëŠ” í”Œë˜ê·¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

í•´ë‹¹ í”Œë˜ê·¸ë¥¼ ì„¤ì •í•˜ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, LocalStorage ë³´ë‹¤ ì•ˆì „í•˜ê²Œ í† í°ì„ ë³´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ë©´ ë§¤ ìš”ì²­ ì‹œ í† í°ì„ êº¼ë‚´ê³  í—¤ë”ì— ì¶”ê°€í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ê°œë°œì˜ í¸ì˜ì„± ë˜í•œ ë†’ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ì´ëŸ¬í•œ ìƒí™©ìœ¼ë¡œ ì¸í•´ í—¤ë”ë¥¼ ì‚¬ìš©í•œ ë°©ë²•ì´ ì•„ë‹Œ, ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ ë°©ë²•ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

---
### ê¸°ì¡´ì˜ ì¸ì¦ ë°©ì‹

ê¸°ì¡´ì˜ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```java
@Component
public class LoginMemberResolver implements HandlerMethodArgumentResolver {

    private static final String BEARER_TOKEN_PREFIX = "Bearer ";

    private final AuthExtractor authExtractor;

    public LoginMemberResolver(AuthExtractor authExtractor) {
        this.authExtractor = authExtractor;
    }

    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        return parameter.getParameterType().equals(LoginMember.class) && parameter.hasParameterAnnotation(Login.class);
    }

    @Override
    public LoginMember resolveArgument(...) {
        String header = webRequest.getHeader(HttpHeaders.AUTHORIZATION);
        String token = extractToken(header);
        AuthPayload authPayload = authExtractor.extract(token);
        return new LoginMember(authPayload.getMemberId());
    }

    private String extractToken(String header) {
        validateHeader(header);
        return header.substring(BEARER_TOKEN_PREFIX.length()).trim();
    }

    private void validateHeader(String header) {
        if (header == null) {
            throw new UnauthorizedException(...);
        }
        if (!header.toLowerCase().startsWith(BEARER_TOKEN_PREFIX.toLowerCase())) {
            throw new UnauthorizedException(...);
        }
    }
}
```

ì´ë•ŒëŠ” ì—­í• ì´ë¼ëŠ” ë„ë©”ì¸ì´ ì—†ê³  ë‹¨ìˆœíˆ ì‚¬ìš©ìì— ëŒ€í•œ ì¸ì¦ë§Œ ìˆì—ˆê¸° ë•Œë¬¸ì— `ArgumentResolver`ë¡œ ì¸ì¦ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì— `@Login` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì´ë©´ í•´ë‹¹ í•¸ë“¤ëŸ¬ì— ì¸ì¦ ê¸°ëŠ¥ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.

```java
@GetMapping("/profile")
public ResponseEntity<MemberProfileResponse> findMemberProfile(@Login LoginMember loginMember) {
    ...
}
```
### ì¶”ê°€ëœ ê¸°ëŠ¥, ë°œìƒí•œ ë¬¸ì œì 

ì§€ê¸ˆê¹Œì§€ ê´€ë¦¬ì ì›¹ í˜ì´ì§€ì— ì ‘ì†í•  ë•Œ ì¸ì¦, ì¸ê°€ ì‘ì—… ì—†ì´ ëˆ„êµ¬ë‚˜ ì ‘ì†ì´ ê°€ëŠ¥í–ˆê¸° ë•Œë¬¸ì— ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.

ìœ„ì—ì„œ ì„¤ëª…í–ˆë“¯, ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ì€ í—¤ë”ê°€ ì•„ë‹Œ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ê¸°ì¡´ì˜ ì¸ì¦ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” `LoginMemberResolver`ì—ëŠ” í—¤ë”ë¥¼ í†µí•œ ì¸ì¦ë§Œ ë˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```java
@Component
public class LoginMemberResolver implements HandlerMethodArgumentResolver {
    ...
    @Override
    public LoginMember resolveArgument(...) {
        String header = webRequest.getHeader(HttpHeaders.AUTHORIZATION);
        String token = extractToken(header);
        AuthPayload authPayload = authExtractor.extract(token);
        return new LoginMember(authPayload.getMemberId());
    }
    ...
}
```

ë”°ë¼ì„œ ê´€ë¦¬ìì˜ ì¸ì¦ì€ ê¸°ì¡´ì˜ `LoginMemberResolver`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê³  ìƒˆë¡œìš´ `ArgumentResolver`ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```java
@Component
public class LoginAdminResolver implements HandlerMethodArgumentResolver {
    ...
    @Override
    public LoginMember resolveArgument(...) {
        Cookie[] cookies = request.getCookies();
        String token = extractToken(cookies);
        AuthPayload authPayload = authExtractor.extract(token);
        if (authPayload.getRole() != Role.ADMIN) {
            throw new ForbiddenException(...);
        }
        return new LoginMember(authPayload.getId());
    }
}
```

ê·¸ëŸ¬ë©´ ì´ì œ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ `@LoginAdmin` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@PostMapping("/festivals")
public ResponseEntity<Void> createFestival(@Admin LoginMember loginMember,
                                           @RequestBody FestivalCreateRequest request) {
    festivalService.create(request);  
    return ResponseEntity.ok()
        .build();
}
```

ì´ë ‡ê²Œ ì—¬ëŸ¬ ì‚¬ìš©ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ ì‘ì—…ì´ ëë‚¬ì„ê¹Œìš”..?

ì•ˆíƒ€ê¹ê²Œë„ ì—¬ê¸°ì—ëŠ” ì—¬ëŸ¬ ë¬¸ì œì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.
#### í•„ìš”í•˜ì§€ ì•Šì€ íŒŒë¼ë¯¸í„°

`createFestival` í•¸ë“¤ëŸ¬ ë©”ì„œë“œì—ì„œ `LoginMember` íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¸ì¦ì„ ìœ„í•´ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ì— LoginMember íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
#### ì •ì  íŒŒì¼ì— ëŒ€í•œ ì¸ì¦

ì¸ì¦ ì‘ì—…ì„ `ArgumentResolver`ì—ì„œ ìˆ˜í–‰í•˜ë¯€ë¡œ, í•¸ë“¤ëŸ¬ ë©”ì„œë“œë¡œ ì§€ì •ëœ ê²½ë¡œë§Œ ì¸ì¦ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì •ì  íŒŒì¼ì— ëŒ€í•œ ì¸ì¦ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ê´€ë¦¬ì ì›¹ í˜ì´ì§€ì˜ JS íŒŒì¼ì´ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ì–´ì°¨í”¼ JS íŒŒì¼ì„ ì—´ì–´ë³´ë”ë¼ë„ ì¸ì¦ì´ ë˜ì§€ ì•Šìœ¼ë©´ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ê¸´ í•˜ë‚˜, ê´€ë¦¬ìì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ë…¸ì¶œëœë‹¤ëŠ” ì ì´ ë³´ì•ˆ ì¸¡ë©´ì—ì„œ ì·¨ì•½í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.
### ì–´ë–»ê²Œ í•´ê²°í•  ê²ƒì¸ê°€?

ì§€ê¸ˆê¹Œì§€ì˜ ìƒí™©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![](images/20230822151035.png)
![](images/20230822151040.png)
![](images/20230822151045.png)

ë”°ë¼ì„œ ë¬¸ì œì ì„ í•´ê²°í•˜ë ¤ë©´, `ArgumentResolver`ë¡œ ì¸ì¦ì„ í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ `Interceptor`ë¡œ íŠ¹ì • ê²½ë¡œì— ëŒ€í•œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ë©´ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ì—¬ê¸°ì„œ `Interceptor`ëŠ”  `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ ë§í•©ë‹ˆë‹¤.

`Interceptor`ë¥¼ ì‚¬ìš©í•˜ë©´ ìš”ì²­ê³¼ ì‘ë‹µì„ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ì—ëŠ” ì„¸ ê°œì˜ default ë©”ì„œë“œê°€ ìˆìŠµë‹ˆë‹¤.

```java
default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  
   return true;  
}

default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception { 
}

default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception {  
}
```

ì´ ì¤‘ì—ì„œ ì €í¬ê°€ ë´ì•¼í•  ë©”ì„œë“œëŠ” `preHandle()` ì…ë‹ˆë‹¤.

`preHandle()` ë©”ì„œë“œëŠ” ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì„œë“œë¡œ, í•´ë‹¹ ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ì—¬ ìš”ì²­ì´ í•¸ë“¤ëŸ¬ ë©”ì„œë“œë¡œ ë„˜ì–´ê°€ê¸° ì „ì— ì¸ì¦ ê³¼ì •ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`HandlerInterceptor`ë¥¼ êµ¬í˜„í•œ InterceptorëŠ” ë‹¤ìŒê³¼ ê°™ì´ `WebMvcConfigurer`ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì— `addInterceptors()` ë©”ì„œë“œë¥¼ ì¬ì •ì˜ í•œ ë’¤ `registry` íŒŒë¼ë¯¸í„°ì— ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    ...
    @Override  
    public void addInterceptors(InterceptorRegistry registry) {  
        registry.addInterceptor(adminAuthInterceptor())  
            .addPathPatterns("/admin/**", "/js/admin/**")  
            .excludePathPatterns("/admin/login");  
        registry.addInterceptor(memberAuthInterceptor())
            .addPathPatterns("/members/**");
    }

    @Bean  
    public HandlerInterceptor adminAuthInterceptor() {  
        return new AuthInterceptor(Role.ADMIN, authExtractor);
    }  
      
    @Bean  
    public HandlerInterceptor memberAuthInterceptor() {  
        return new AuthInterceptor(Role.MEMBER, authExtractor);
    }
}
```
#### Interceptor

ê¸°ì¡´ì˜ `ArgumentResolver`ì—ì„œëŠ” ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒê³¼ í† í°ì„ `AuthExtractor`ì— ì „ë‹¬í•˜ì—¬ `LoginMember`ë¥¼ ë°˜í™˜í•˜ëŠ” ë‘ ê°€ì§€ì˜ ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì±…ì„ì„ Interceptorë¡œ ìœ„ì„í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ì‚¬ìš©ìì™€ ê´€ë¦¬ìëŠ” í† í°ì„ ë³´ë‚´ëŠ” ë°©ì‹ì´ ë‹¬ë¼ì„œ, ì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œë¥¼ ë¶„ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

```java
public class AuthInterceptor implements HandlerInterceptor {

    private final Role role;
    private final AuthExtractor authExtractor;
    
    @Override  
    public boolean preHandle(...) throws Exception {
        String token;
        if (role == Role.MEMBER) {
            token = getHeaderToken(request);
        }
        if (role == Role.ADMIN) {
            token = getCookieToken(request);
        }
        if (token == null) {
            throw new UnauthorizedException(...);
        }
        AuthPayload authPayload = authExtractor.extract(token);
        ...
    }
}
```

í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ ìƒˆë¡œìš´ ì—­í• ì´ ì¶”ê°€ëœë‹¤ë©´ ì¡°ê±´ë¬¸ì´ ì¶”ê°€ë¡œ ìƒê¸°ê²Œ ë  ê²ƒì´ê³  í•œëˆˆì— ë´ë„ ì´ ë°©ë²•ì€ ì© ìœ ì¾Œí•˜ì§€ ì•Šì•„ ë³´ì…ë‹ˆë‹¤.
#### ì„œë¡œ ë‹¤ë¥¸ ì¸ì¦ ë°©ì‹

ìœ„ì˜ êµ¬í˜„ì—ì„œëŠ” ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì„ ì—­í• ì— ë”°ë¼ êµ¬ì²´ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì´ ë‹¤ë¥¸ ê²ƒì€ ë§ì§€ë§Œ, êµ³ì´ ì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì„ ë¶„ë¦¬í•  í•„ìš”ê°€ ìˆì„ê¹Œìš”?

ì´ê²ƒì„ í•˜ë‚˜ì˜ ì±…ì„ìœ¼ë¡œ ë³¸ë‹¤ë©´ ë‹¤ë¥¸ ê°ì²´ê°€ ì´ê²ƒì„ ë‹´ë‹¹í•˜ê²Œ í•˜ëŠ” ê²ƒì„ ìƒê°í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public interface TokenExtractor {
    Optional<String> extract(HttpServletRequest request);
}
```

ê·¸ë¦¬ê³  `TokenExtractor`ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë‘ ê°œì˜ êµ¬í˜„ì²´ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.

```java
public class CookieTokenExtractor implements TokenExtractor {
    ...
}

public class HeaderTokenExtractor implements TokenExtractor {
    ...
}
```

ì´ì œ ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì„ `TokenExtractor`ì— ìœ„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public class AuthInterceptor implements HandlerInterceptor {
    ...
    private final TokenExtractor tokenExtractor;

    @Override  
    public boolean preHandle(...) throws Exception {
        String token = tokenExtractor.extract(request)
            .orElseThrow(() -> new UnauthorizedException(...));
        AuthPayload authPayload = authExtractor.extract(token);
        if (authPayload.getRole() != role) {
            throw new ForbiddenException(...);
        }
        return true; // boolean..?
    }
}
```

ê·¸ëŸ°ë° `preHandle()` ë©”ì„œë“œì˜ ë°˜í™˜ íƒ€ì…ì€ booleanì¸ë°, ì–´ë–»ê²Œ AuthPayloadì— ìˆëŠ” ê°’ì„ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆì„ê¹Œìš”?
#### HandlerInterceptor -> ArgumentResolver

`preHandle()` ë©”ì„œë“œë¡œ ë„˜ì–´ì˜¤ëŠ” `HttpServletRequest` ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ì„œë“œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

```java
Object getAttribute(String name);

void setAttribute(String name, Object o);
```

ë”°ë¼ì„œ Interceptorì—ì„œ ì¸ì¦ì´ ëë‚˜ê³  ë°˜í™˜ëœ `AuthPayload` ê°ì²´ë¥¼ `setAttribute()` ë©”ì„œë“œë¥¼ í†µí•´ `ArgumentResolver`ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public class AuthInterceptor implements HandlerInterceptor {

    @Override  
    public boolean preHandle(...) throws Exception {
        String token = tokenExtractor.extract(request)
            .orElseThrow(() -> new UnauthorizedException(...));
        AuthPayload authPayload = authExtractor.extract(token);
        request.setAttribute(AuthPayload.class.getName(), authPayload);
        return true;
    }
}
```

ì´ì œ `ArgumentResolver`ëŠ” WebRequest ê°ì²´ì˜  `getAttribute()` ë©”ì„œë“œë¥¼ í†µí•´ `AuthPayload`ë¥¼ êº¼ë‚¸ ë’¤, í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¦¬ë¯¸í„°ì— ê°’ì„ ë§¤í•‘í•˜ë©´ ë©ë‹ˆë‹¤.

> Attributeì˜ keyê°€ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, `AuthPayload.class.getName()`ê³¼ ê°™ì´ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ê³ ìœ í•œ íŒ¨í‚¤ì§€ ëª…ê³¼ í´ë˜ìŠ¤ ëª…ì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ë¬¸ì œë¥¼ í•´ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.

```java
public class AuthArgumentResolver implements HandlerMethodArgumentResolver {
    ...
    @Override  
    public LogimMember resolveArgument(...) throws Exception {  
        AuthPayload authPayload = getAuthPayload(webRequest);
        return new LoginMember(authPayload.getId()); 
    }

    private AuthPayload getAuthPayload(NativeWebRequest request) {
        AuthPayload authPayload = (AuthPayload) request.getAttribute(AuthPayload.class.getName(), RequestAttributes.SCOPE_REQUEST);  
        if (authPayload == null) {  
            return AuthPayload.ANONYMOUS; // new AuthPayload(null, Role.ANONYMOUS); 
        }  
        return authPayload;
    }
}
```

ë”°ë¼ì„œ ì´ì œë¶€í„° ì‚¬ìš©ìê°€ ì ‘ì†í•˜ëŠ” ê²½ë¡œì— ë”°ë¼ ì¸ì¦ê³¼ ì¸ê°€ ê¸°ëŠ¥ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.
![](images/20230822170744.png)
### ì¸ì¦ ì¸ê°€ í…ŒìŠ¤íŠ¸

ê·¸ë ‡ë‹¤ë©´ ì´ì œ ëª¨ë“  ê¸°ëŠ¥ì„ ì œì‘í–ˆìœ¼ë‹ˆ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì•¼ê² ì£ ?

ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ì ‘ì†í•  ë•Œ, ê´€ë¦¬ì ê¶Œí•œì´ ì•„ë‹Œ ì‚¬ìš©ìë©´ 401 ìƒíƒœì½”ë“œê°€ ë°˜í™˜ë˜ëŠ” ê²ƒì„ ê²€ì¦í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```java
@WebMvcTest(AdminController.class)
class AdminControllerTest {
    @Test
    void í† í°ì˜_Roleì´_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  
        // when & then  
        mockMvc.perform(get("/admin")  
                .cookie(new Cookie("token", "token")))  
            .andExpect(status().isUnauthorized());  
    }
}
```

í•´ë‹¹ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë‹¹ì—°í•˜ê²Œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

ì™œëƒí•˜ë©´ `Interceptor` í•„ë“œì˜ `AuthExtractor`ê°€ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë˜í•œ `AuthExtractor`ëŠ” ì¸í„°í˜ì´ìŠ¤ì´ê³ , í•´ë‹¹ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” JWT í† í°ìœ¼ë¡œ ì¸ì¦ì„ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ Mockitoì˜ `@MockBean` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ê±°ë‚˜, í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì—ì„œ `@Import` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ `AuthExtractor`ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ ë©ë‹ˆë‹¤.

```java
@Import(FakeAuthExtractor.class) // Fake
@WebMvcTest(AdminController.class)
class AdminControllerTest {

    @MockBean
    AuthExtractor authExtractor; // Mock
}
```

ê·¸ëŸ°ë° ì´ë ‡ê²Œ Fake ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, Mock ê°ì²´ë¥¼ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.
#### Fake ì‚¬ìš©ì˜ ë¬¸ì œ

`FakeAuthExtractor` í´ë˜ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤.

```java
public class FakeAuthExtractor implements AuthExtractor {
    @Override  
    public AuthPayload extract(String token) {  
        if (Objects.equals(token, "member")) {
            return new AuthPayload(1L, Role.MEMBER);
        }
        if (Objects.equals(token, "admin")) {
            return new AuthPayload(1L, Role.ADMIN);  
        }
        return AuthPayload.ANONYMOUS;
    }
}
```

JWT í† í°ì„ ì§ì ‘ íŒŒì‹±í•˜ì—¬, AuthPayload ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ í•„ìš”ëŠ” ì—†ìœ¼ë‹ˆ ë‹¨ìˆœíˆ í•˜ë“œì½”ë”©ëœ ê°’ìœ¼ë¡œ AuthPayload ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ í•´ë‹¹ Fake ê°ì²´ì˜ ë¬¸ì œì ì€ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ `FakeAuthExtractor`ì˜ êµ¬í˜„ ì‚¬í•­ì— ì˜ì¡´ì ìœ¼ë¡œ ë³€í•˜ê²Œ ë©ë‹ˆë‹¤.

```java
mockMvc.perform(get("/admin")  
        .cookie(new Cookie("token", "member"))) // ìƒˆë¡œìš´ ì—­í• ì´ ìƒê¸°ë©´ FakeAuthExtractorë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤!
    .andExpect(status().isUnauthorized());  
```
#### Mock ì‚¬ìš©ì˜ ë¬¸ì œ

Mockitoë¥¼ ì‚¬ìš©í•˜ë©´ Stub ê°ì²´ë¥¼ ë§¤ìš° ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ Stubì´ í•„ìš”í•œ ë©”ì„œë“œë§ˆë‹¤  `given()`ê³¼ ê°™ì´ ëª¨ì˜ ë™ì‘ì„ ì •ì˜í•´ ì¤˜ì•¼ í•˜ëŠ” ì¤‘ë³µ ì½”ë“œê°€ ë°œìƒí•©ë‹ˆë‹¤.

```java
@Test
void test1() {  
    // given
    given(authExtractor.extract(anyString()))    
        .willReturn(new AuthPayload(1L, Role.MEMBER));
    ...
}

@Test
void test2() {  
    // given
    given(authExtractor.extract(anyString()))    
        .willReturn(new AuthPayload(1L, Role.ADMIN));
    ...
}
```

#### ê³µí†µì ì¸ ë¬¸ì œì 

ê²°êµ­ Fake ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë˜, Mock ê°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë“  ê°„ì— í…ŒìŠ¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë ¤ë©´ `AuthExtrator` ë¹ˆì´ í•„ìš”í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë§ˆë‹¤ í•´ë‹¹ ê°ì²´ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì½”ë“œë¥¼ ë§¤ë²ˆ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

```java
@Import(FakeAuthExtractor.class) 

// ë˜ëŠ”

@MockBean
AuthExtractor authExtractor;
```

ì´ëŸ¬í•œ ë¬¸ì œì ì€  `@WebMvcTest` í…ŒìŠ¤íŠ¸ì—ì„œ, MVC ê´€ë ¨ ë¹ˆë“¤ë§Œ ë¶ˆëŸ¬ì˜¤ê¸° ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.

```java
@TypeExcludeFilters(WebMvcTypeExcludeFilter.class) <--
...
public @interface WebMvcTest {
    ...
}
```

`WebMvcTypeExcludeFilter` í´ë˜ìŠ¤ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ íŠ¹ì • ë¹ˆë“¤ë§Œ ë“±ë¡í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public final class WebMvcTypeExcludeFilter extends StandardAnnotationCustomizableTypeExcludeFilter<WebMvcTest> {
    ...
    static {  
       Set<Class<?>> includes = new LinkedHashSet<>();  
       includes.add(ControllerAdvice.class);  
       includes.add(JsonComponent.class);  
       includes.add(WebMvcConfigurer.class);  
       includes.add(WebMvcRegistrations.class);  
       includes.add(jakarta.servlet.Filter.class);  
       includes.add(FilterRegistrationBean.class);  
       includes.add(DelegatingFilterProxyRegistrationBean.class); 
       includes.add(HandlerMethodArgumentResolver.class);  
       includes.add(HttpMessageConverter.class);  
       includes.add(ErrorAttributes.class);  
       includes.add(Converter.class);  
       includes.add(GenericConverter.class);  
       includes.add(HandlerInterceptor.class);
       ...
   }
}
```

ê·¸ë ‡ë‹¤ë©´ í•´ê²°ë²•ì€ ìƒê°ë³´ë‹¤ ë‹¨ìˆœí•©ë‹ˆë‹¤.

`@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ í™•ì¥í•œ ì»¤ìŠ¤í…€ `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

```java
@WebMvcTest  
@Import(TestAuthConfig.class)  
@Retention(RetentionPolicy.RUNTIME)  
public @interface CustomWebMvcTest {  
  
    @AliasFor("controllers")  
    Class<?>[] value() default {};  
  
    @AliasFor("value")  
    Class<?>[] controllers() default {};  
}
```

`@WebMvcTest`ì—ëŠ” ì†ì„±ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í´ë˜ìŠ¤ë¥¼ ì ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

ë§Œì•½ ì ì–´ì£¼ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë¹ˆìœ¼ë¡œ ì£¼ì…í•˜ë‹ˆ, `NoSuchBeanDefinitionException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ë¯€ë¡œ íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë¥¼ ì ì–´ì£¼ê¸° ìœ„í•´ ê¸°ì¡´ `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì— ìˆë˜ íŒŒë¼ë¯¸í„°ë“¤ì„ ì ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  `@Import` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ `TestAuthConfig` í´ë˜ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ì£¼ì…í•˜ì˜€ìŠµë‹ˆë‹¤.

`TestAuthConfig` í´ë˜ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```java
@TestConfiguration  
public class TestAuthConfig {

    @Bean
    public AuthExtractor authExtractor() {
        // return Mockito.mock(AuthExtractor.class);
        return new FakeAuthExtractor();
    }
}
```

ì´ì œ `@CustomWebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤!

```java
@CustomWebMvcTest(AdminController.class)
class AdminControllerTest {
    @Test
    void í† í°ì˜_Roleì´_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  
        // when & then  
        mockMvc.perform(get("/admin")  
                .cookie(new Cookie("token", "token")))  
            .andExpect(status().isUnauthorized());  
    }
}
```
### ì—¬ì „í•œ ë¬¸ì œì 

í•˜ì§€ë§Œ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì§€ìš°ê¸´ í–ˆì–´ë„ ì—¬ì „íˆ ê·¼ë³¸ì ì¸ ë¬¸ì œëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.

Fakeë¥¼ ì‚¬ìš©í•  ê²ƒì´ëƒ, Mockì„ ì‚¬ìš©í•  ê²ƒì´ëƒì…ë‹ˆë‹¤.

Fakeë¥¼ ì‚¬ìš©í•œë‹¤ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ Fakeì˜ ë™ì‘ì— ì¢…ì†ì ìœ¼ë¡œ ë˜ê³ , Mockì„ ì‚¬ìš©í•œë‹¤ë©´ ë§¤ë²ˆ ëª¨ì˜ ë™ì‘ì„ ì •ì˜í•´ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.

í•´ë‹¹ í…ŒìŠ¤íŠ¸ì˜ í•µì‹¬ì€ ì¸ì¦ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì¸ì¦ì´ ëœ ì‚¬ìš©ìë§Œ ìš”ì²­ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ì¸ì¦ì˜ êµ¬ì²´ì ì¸ ë°©ë²•ì€ ì¤‘ìš”í•˜ì§€ ì•Šê³ , ê²½ë¡œì— ë”°ë¼ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€, í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ì™€ ì¸ê°€ëœ ì‚¬ìš©ìë¥¼ êµ¬ë¶„ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ ì´ëŸ° ì‘ì—…ì„ ì¤‘ë³µëœ ì½”ë“œ ì—†ì´ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì„ê¹Œìš”?
#### TestExecutionListener

ìŠ¤í”„ë§ì€ ë‹¤ìŒê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

```java
public interface TestExecutionListener {
    default void beforeTestClass(TestContext testContext) throws Exception {};
    default void prepareTestInstance(TestContext testContext) throws Exception {};
    default void beforeTestMethod(TestContext testContext) throws Exception {};
    default void afterTestMethod(TestContext testContext) throws Exception {};
    default void afterTestClass(TestContext testContext) throws Exception {};
}
```

í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ, ì „ì²˜ë¦¬ ê³¼ì •ì„ ìˆ˜í–‰í•  ë©”ì„œë“œë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì— ë“±ë¡ì‹œí‚¤ë©´ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì—†ì•¨ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ì–´, ì¸ì¦ì´ í•„ìš”í•œ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë§ˆë‹¤ ì ìš©ì„ í•œë‹¤ë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```java
@Retention(RetentionPolicy.RUNTIME)  
@Target(ElementType.METHOD)  
public @interface WithMockAuth {  
  
    long id() default 1;  
  
    Role role() default Role.MEMBER;  
}
```

```java
@Test
void ì‚¬ìš©ìê°€_ë¡œê·¸ì¸ì„_í•˜ì§€_ì•Šìœ¼ë©´_ì•„ë‹ˆë©´_401() throws Exception {  
    // when & then  
    mockMvc.perform(get("/admin")  
            .cookie(new Cookie("token", "token")))  
        .andExpect(status().isUnauthorized());  
}

@Test
@WithMockAuth(role = Role.MEMBER)
void ì‚¬ìš©ìê°€_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  
    // when & then  
    mockMvc.perform(get("/admin")  
            .cookie(new Cookie("token", "token")))  
        .andExpect(status().isUnauthorized());  
}

@Test
@WithMockAuth(role = Role.ADMIN)
void ì‚¬ìš©ìê°€_ì–´ë“œë¯¼_ì´ë©´_200() throws Exception {  
    // when & then  
    mockMvc.perform(get("/admin")  
            .cookie(new Cookie("token", "token")))  
        .andExpect(status().ikOk());  
}
```

í•˜ì§€ë§Œ ì–´ë–»ê²Œ êµ¬í˜„ì„ í•´ì•¼í• ê¹Œìš”?
#### TestExecutionListener êµ¬í˜„

ì ê¹ `AuthInterceptor`ì˜ `preHandle()` ë©”ì„œë“œë¥¼ ë³´ê² ìŠµë‹ˆë‹¤.

```java
@Override  
public boolean preHandle(...) throws Exception {
    String token = tokenExtractor.extract(request)
        .orElseThrow(() -> new UnauthorizedException(...));
    AuthPayload authPayload = authExtractor.extract(token);
    if (authPayload.getRole() != role) {
        throw new ForbiddenException(...);
    }
    request.setAttribute(AuthPayload.class.getName(), authPayload);
    return true;
}
```

ì¸ì¦, ì¸ê°€ì— ëŒ€í•œ ê°€ì¥ í° í•µì‹¬ì ì¸ ë¶€ë¶„ì€ `AuthExtractor` í´ë˜ìŠ¤ì˜ `extract()` ë©”ì„œë“œ ì…ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ `TestExecutionListener`ë¥¼ ì‚¬ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ê°€ ìˆ˜í–‰ë˜ê¸° ì „ ì „ì²˜ë¦¬ ì‘ì—…ì„ í†µí•´ì„œ `extract()` ë©”ì„œë“œì˜ ë°˜í™˜ ê°’ì„ ì¡°ì‘í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

`TestExecutionListener`ì˜ ì¶”ìƒ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì—ëŠ” ê³µí†µìœ¼ë¡œ `TestContext` ê°ì²´ê°€ ì œê³µë©ë‹ˆë‹¤.

`TestContext` ê°ì²´ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
public interface TestContext extends AttributeAccessor, Serializable {
    ...
    Method getTestMethod();
    ...
    ApplicationContext getApplicationContext();
    ...
}
```

`getTestMethod()` ë©”ì„œë“œë¡œ ì œê³µë˜ëŠ” `Method` ê°ì²´ì—ëŠ” ë©”ì†Œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œê°€ ì œê³µë©ë‹ˆë‹¤.

```java
public boolean isAnnotationPresent(Class<? extends Annotation> annotationClass) {  
    return super.isAnnotationPresent(annotationClass);  
}

public <T extends Annotation> T getDeclaredAnnotation(Class<T> annotationClass) {  
    return this.getAnnotation(annotationClass);  
}
```

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
2. íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì„ ê°€ì ¸ì˜¨ë‹¤.
3. ApplicationContext ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ ë’¤, AuthExtractor ë¹ˆì„ êº¼ë‚¸ë‹¤.
4. AuthExtractorê°€ íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì˜ ì†ì„±ìœ¼ë¡œ ì •ì˜ëœ í•„ë“œë¥¼ ë°˜í™˜í•˜ë„ë¡ í•œë‹¤.

í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  `AuthExtractor` ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

```java
public class MockAuthExtractor implements AuthExtractor {  
  
    private Long memberId = null;  
    private Role role = Role.ANONYMOUS;  
  
    public void setMemberId(Long memberId) {  
        this.memberId = memberId;  
    }  
  
    public void setRole(Role role) {  
        this.role = role;  
    }  
  
    @Override  
    public AuthPayload extract(String token) {  
        return new AuthPayload(memberId, role);  
    }  
}
```

ê·¸ë¦¬ê³  `TestExecutionListener`ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì—ì„œ `beforeTestMethod()` ë©”ì„œë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ë˜í•œ í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ê°€ ì˜í–¥ì„ ë°›ì§€ ì•Šì•„ì•¼ í•˜ë¯€ë¡œ, `afterTestMethod()` ë©”ì„œë“œë„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```java
public class MockAuthTestExecutionListener implements TestExecutionListener {  
  
    @Override  
    public void beforeTestMethod(TestContext testContext) throws Exception {  
        Method testMethod = testContext.getTestMethod();  
        if (testMethod.isAnnotationPresent(WithMockAuth.class)) {  
            WithMockAuth withMockAuth = testMethod.getDeclaredAnnotation(WithMockAuth.class);  
            ApplicationContext applicationContext = testContext.getApplicationContext();  
            MockAuthExtractor authExtractor = applicationContext.getBean(MockAuthExtractor.class);  
            authExtractor.setMemberId(withMockAuth.id());  
            authExtractor.setRole(withMockAuth.role());  
        }  
    }

    @Override  
    public void afterTestMethod(TestContext testContext) throws Exception { 
        ApplicationContext applicationContext = testContext.getApplicationContext();  
        MockAuthExtractor authExtractor = applicationContext.getBean(MockAuthExtractor.class);  
        authExtractor.setMemberId(null);  
        authExtractor.setRole(Role.ANONYMOUS);  
    }
}
```

ê·¸ë¦¬ê³  ì´ì „ì— ë§Œë“¤ì—ˆë˜ `@CustomWebMvcTest`ì— `TestExecutionListener`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•˜ë©´ ëª¨ë“  ì‘ì—…ì´ ëë‚©ë‹ˆë‹¤.

```java
@WebMvcTest  
@Import(TestAuthConfig.class)  
@Retention(RetentionPolicy.RUNTIME)  
@TestExecutionListeners(MockAuthTestExecutionListener.class) <--
public @interface CustomWebMvcTest {
    ...
}
```

í•˜ì§€ë§Œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©° í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

```java
java.lang.NullPointerException: Cannot invoke "com.festago.application.StageService.create(com.festago.dto.StageCreateRequest)" because "this.stageService" is null
```

ì™œëƒí•˜ë©´ `@WebMvcTest`ë¥¼ ìˆ˜í–‰í•  ë•Œ, ê¸°ë³¸ì ìœ¼ë¡œ ë“±ë¡ëœ `TestExecutionListener`ê°€ ìˆëŠ”ë° `@TestExecutionListeners`ë¥¼ ìƒˆë¡­ê²Œ ì‚¬ìš©í•˜ë©´ì„œ ê¸°ì¡´ì˜ `TestExecutionListener`ê°€ ëŒ€ì²´ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ìƒˆë¡œìš´ `TestExecutionListener`ë¥¼ ë“±ë¡í•˜ë©´ì„œ ê¸°ì¡´ì˜ `TestExecutionListener`ëŠ” ìœ ì§€ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.

ì´ê²ƒì€ `@TestExecutionListeners`ì˜ `mergeMode` ì†ì„±ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@TestExecutionListeners(listeners = MockAuthTestExecutionListener.class, mergeMode = MergeMode.MERGE_WITH_DEFAULTS)
```

`@TestExecutionListeners`ì˜ `mergeMode` ì†ì„±ì˜ ê¸°ë³¸ê°’ì€ `REPLACE_DEFAULTS` ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ `MERGE_WITH_DEFAULTS` ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ì˜ `TestExecutionListener`ë¥¼ ëŒ€ì²´í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ `TestExecutionListener`ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ì¸ì¦, ì¸ê°€ê°€ í•„ìš”í•œ í…ŒìŠ¤íŠ¸ì— ë‹¤ìŒê³¼ ê°™ì€ ì–´ë…¸í…Œì´ì…˜ë§Œ ì¶”ê°€ì‹œí‚¤ë©´ ê°„í¸í•˜ê²Œ ì¸ì¦, ì¸ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@CustomWebMvcTest(AuthController.class)
class AuthControllerTest {
    @Test
    @WithMockAuth(role = Role.ADMIN)
    void ë©¤ë²„_ê¶Œí•œì´_ì•„ë‹Œë°_íƒˆí‡´í•˜ë©´_ì˜ˆì™¸() throws Exception {
        mockMvc.perform(delete("/auth")
                .header("Authorization", "Bearer token")
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isNotFound());
    }

    @Test
    @WithMockAuth
    void íšŒì›_íƒˆí‡´ë¥¼_í•œë‹¤() throws Exception {
        mockMvc.perform(delete("/auth")
                .header("Authorization", "Bearer token")
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk());
    }
}
```

## ê²°ë¡ 

ê¸°ì¡´ì˜ ì¸ì¦ ë°©ì‹ì—ëŠ” í•˜ë‚˜ì˜ ì—­í• ë§Œ ì¡´ì¬í•˜ì—¬, í•˜ë‚˜ì˜ ì¸ì¦ ë°©ì‹ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¨ìˆœí•œ ë°©ì‹ì˜ ì¸ì¦ ê¸°ëŠ¥ë§Œ ìˆ˜í–‰í•˜ë©´ ëìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ê´€ë¦¬ì ë˜ëŠ” ìŠ¤íƒœí”„ê°™ì´ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì–´ ì¶”ê°€ì ì¸ ì¸ì¦ ë°©ì‹ì´ í•„ìš”í•˜ê²Œ ëìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ìƒˆë¡œìš´ ì¸ì¦ ë°©ì‹ì´ ì¶”ê°€ ë˜ë”ë¼ë„ í° ë³€ê²½ ì—†ì´ ì¸ì¦ ë° ì¸ê°€ ì‘ì—…ì´ í•„ìš”í•˜ì˜€ê³ , ì¸ì¦, ì¸ê°€ë¥¼ `Interceptor`ì—ì„œ ìˆ˜í–‰í•˜ë„ë¡ í•œ ë’¤, í† í°ì„ ì¶”ì¶œí•˜ê³  í† í°ì—ì„œ ì¸ì¦ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ì±…ì„ì„ ê°€ì§„ ê°ì²´ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„±ì´ ë†’ì€ ì½”ë“œë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

ë˜í•œ `@WebMvcTest` í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ì¸ì¦, ì¸ê°€ ì‘ì—…ìœ¼ë¡œ ì¤‘ë³µì ìœ¼ë¡œ ë°œìƒí•˜ê²Œ ë˜ëŠ” ì½”ë“œ ë˜í•œ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ê³¼ `TestExecutionListener`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µëœ ì½”ë“œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§Œì•½ `Request` ê°ì²´ì˜ `Attribute`ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì§€ ì•Šë‹¤ë©´, `RequestScope` ë²”ìœ„ë¥¼ ê°€ì§„ ë¹ˆì„ ì£¼ì…í•˜ì—¬ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> `Attribute`ì—ì„œ ê°’ì„ êº¼ë‚¼ ë•Œ Object íƒ€ì…ìœ¼ë¡œ ì¶”ì¶œì´ ë˜ë¯€ë¡œ, í˜•ë³€í™˜ ê³¼ì •ì´ í•„ìš”í•˜ê³ , êº¼ë‚¸ ê°ì²´ê°€ nullable í•˜ë¯€ë¡œ í˜ìŠ¤íƒ€ê³ ì˜ ì‹¤ì œ ì½”ë“œì—ì„œëŠ” `RequestScope` ë²”ìœ„ì˜ ë¹ˆì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

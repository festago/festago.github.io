{"componentChunkName":"component---src-pages-search-jsx","path":"/search/","result":{"data":{"allMarkdownRemark":{"nodes":[{"excerpt":"ì„œë¡  ì•ˆë…•í•˜ì„¸ìš”. í˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ í˜ìŠ¤íƒ€ê³ ì—ëŠ” ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ ì‚¬ìš©ìì˜ ì—­í• ì— ë§ëŠ” ì¸ì¦ê³¼ ì¸ê°€ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¨ìˆœíˆ ì—­í• ì— ë”°ë¥¸ êµ¬ë¶„ì´ë¼ë©´ í° ë¬¸ì œê°€ ì—†ê² ì§€ë§Œ, ë‹¤ì–‘í•œ ì‚¬ìš©ìë“¤ì´ ì ‘ì†í•˜ëŠ” í™˜ê²½ì—ì„œ ì¸ì¦ì„ í•˜ëŠ” ë°©ë²•ì—ì„œ ì°¨ì´ë¡œ ì¸í•´ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì–´ë– í•œ ë¬¸ì œì ì— ì§ë©´í–ˆê³ , ì´â€¦","fields":{"slug":"/oauth2-multiple-user-auth/"},"frontmatter":{"date":"August 24, 2023","title":"í˜ìŠ¤íƒ€ê³ ì˜ ì¸ì¦ - ì—¬ëŸ¬ ì‚¬ìš©ìì˜ ì¸ì¦ê³¼ ì¸ê°€","tags":["OAuth2"]},"rawMarkdownBody":"\n## ì„œë¡ \n\nì•ˆë…•í•˜ì„¸ìš”.\n\ní˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ\n\ní˜ìŠ¤íƒ€ê³ ì—ëŠ” ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n\nì´ë ‡ê²Œ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ ì‚¬ìš©ìì˜ ì—­í• ì— ë§ëŠ” ì¸ì¦ê³¼ ì¸ê°€ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në‹¨ìˆœíˆ ì—­í• ì— ë”°ë¥¸ êµ¬ë¶„ì´ë¼ë©´ í° ë¬¸ì œê°€ ì—†ê² ì§€ë§Œ, ë‹¤ì–‘í•œ ì‚¬ìš©ìë“¤ì´ ì ‘ì†í•˜ëŠ” í™˜ê²½ì—ì„œ ì¸ì¦ì„ í•˜ëŠ” ë°©ë²•ì—ì„œ ì°¨ì´ë¡œ ì¸í•´ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì–´ë– í•œ ë¬¸ì œì ì— ì§ë©´í–ˆê³ , ì´ê²ƒì„ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.\n## ë³¸ë¡ \n\ní˜ìŠ¤íƒ€ê³ ëŠ” ì¶•ì œì˜ ê³µì—°ì— ëŒ€í•œ í‹°ì¼“íŒ…ì„ ì˜¤í”„ë¼ì¸ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì˜¨ë¼ì¸ìœ¼ë¡œ í¸í•˜ê²Œ ì˜ˆë§¤í•˜ê³  ë¹ ë¥´ê²Œ ì¶œì…ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\nì ê¹ ì €í¬ ì„œë¹„ìŠ¤ì˜ íë¦„ì— ê´€í•´ ì´ì•¼ê¸°ë¥¼ í•´ë³´ê² ìŠµë‹ˆë‹¤.\n\nì‚¬ìš©ìê°€ ê³µì—°ì— ëŒ€í•´ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ë ¤ê³  í•©ë‹ˆë‹¤.\n\nì´ë•Œ, ì‚¬ìš©ìê°€ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ë ¤ë©´ ìš°ì„  ê³µì—°ê³¼ ì¶•ì œê°€ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n\nê·¸ë ‡ë‹¤ë©´ ê³µì—°ê³¼ ì¶•ì œëŠ” í‹°ì¼“ì„ ì˜ˆë§¤í•˜ëŠ” ì‚¬ìš©ìê°€ ìƒì„±ì„ í•˜ëŠ” ê²ƒì¼ê¹Œìš”?\n\nê³µì—°ê³¼ ì¶•ì œë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ í‹°ì¼“ì„ ì˜ˆë§¤í•˜ëŠ” ì‚¬ìš©ìê°€ ì•„ë‹Œ, ì¶•ì œì™€ ê³µì—°ì„ ê°œìµœí•˜ê³  ì‹¶ì€ ê´€ë¦¬ìì…ë‹ˆë‹¤.\n\nê·¸ë¦¬ê³  ì˜ˆë§¤í•œ í‹°ì¼“ì„ ê²€ì‚¬í•  ë•Œë„ ë§ˆì°¬ê°€ì§€ë¡œ, í‹°ì¼“ì„ ê²€ì‚¬í•˜ëŠ” ì‚¬ìš©ìê°€ ìˆìŠµë‹ˆë‹¤.\n\ní‹°ì¼“ì„ ê²€ì‚¬í•˜ëŠ” ì‚¬ìš©ìëŠ” ê³µì—°ê³¼ ì¶•ì œë¥¼ ìƒì„±í•˜ëŠ” ê´€ë¦¬ìê°€ ì•„ë‹Œ, ê´€ë¦¬ìì— ì˜í•´ ê³ ìš©ëœ ìŠ¤íƒœí”„ì¼ ê²ƒì…ë‹ˆë‹¤.\n\nì´ì²˜ëŸ¼ í˜ìŠ¤íƒ€ê³ ì—ëŠ” ì—­í• ë³„ë¡œ ì±…ì„ì´ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n\n> í‹°ì¼“ì„ ì˜ˆë§¤í•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Member\n> \n> ì¶•ì œì™€ ê³µì—°ì„ ê³„íší•˜ê³  ê°œìµœí•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Admin\n> \n> í‹°ì¼“ì„ ê²€ì‚¬í•˜ê³  ì‹¶ì€ ì‚¬ìš©ì -> Staff\n\nì´ë ‡ë“¯ ì‚¬ìš©ìë“¤ì€ ê°ìì˜ ì—­í• ê³¼ ì±…ì„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.\n\nê·¸ëŸ°ë° ì–´ë–»ê²Œ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆì„ê¹Œìš”?\n\nì €í¬ ì„œë¹„ìŠ¤ëŠ” JWT í† í°ì„ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ë‹ˆ JWT í† í°ì— ë‹¤ìŒê³¼ ê°™ì€ ê°’ì„ ë„£ì„ ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\n```json\n{\n    \"id\": 1,\n    \"role\": \"MEMBER\"\n}\n\n{\n    \"id\": 2,\n    \"role\": \"STAFF\"\n}\n\n{\n    \"id\": 3,\n    \"role\": \"ADMIN\"\n}\n```\n\nì´ë ‡ê²Œ í† í°ì— `role` í•„ë“œë¥¼ ì¶”ê°€í•˜ë©´ ì‚¬ìš©ìì˜ ì—­í• ì„ ì‰½ê²Œ êµ¬ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n\nê° ì—­í• ì˜ ì‚¬ìš©ìë“¤ì€ ì ‘ì†í•˜ëŠ” í™˜ê²½ì´ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.\n\nì¼ë°˜ ì‚¬ìš©ìì™€ ìŠ¤íƒœí”„ëŠ” ëª¨ë°”ì¼ ì•± í™˜ê²½ì—ì„œ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ê´€ë¦¬ìëŠ” ëª¨ë°”ì¼ ì•±ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì›¹ í˜ì´ì§€ë¥¼ í†µí•´ ì €í¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.\n\nê´€ë¦¬ìê°€ ì ‘ì†í•˜ëŠ” í™˜ê²½ì—ì„œëŠ” ì „ìš© ì•±ì„ ì œì‘í•  í•„ìš”ê°€ ì—†ê³  ê°„ë‹¨í•œ ì›¹ í˜ì´ì§€ë§Œ ìˆìœ¼ë©´ ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\n\nê·¸ëŸ°ë° ì´ê²ƒì´ ì™œ ë¬¸ì œê°€ ë˜ëŠ” ê±¸ê¹Œìš”?\n\nëª¨ë°”ì¼ ì•± í™˜ê²½ì—ì„œ ìš”ì²­ì„ ë³´ë‚¼ ë•ŒëŠ” JWT í† í°ì„ HTTP í—¤ë”ì— ë‹´ì•„ ìš”ì²­í•©ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ì›¹ í˜ì´ì§€ í™˜ê²½ì—ì„œëŠ” JWT í† í°ì„ ì¿ í‚¤ì— ë‹´ì•„ ìš”ì²­í•©ë‹ˆë‹¤.\n\nì´ë ‡ê²Œ ì‚¬ìš©ìì˜ í™˜ê²½ë§ˆë‹¤ í† í°ì„ ë³´ë‚´ëŠ” ë°©ë²•ì´ ë‹¤ë¥´ë‹ˆ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n\nì—¬ê¸°ì„œ ì´ëŸ° ìƒê°ì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n> \"ì›¹ í˜ì´ì§€ì—ì„œë„ í—¤ë”ì— í† í°ì„ ë‹´ì•„ì„œ ë³´ë‚´ë©´ ì•ˆë˜ë‚˜ìš”?\"\n\nì›¹ í˜ì´ì§€ë¥¼ í†µí•´ í† í°ì„ í—¤ë”ì— ë‹´ì•„ ìš”ì²­ì„ í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n\në‹¨ìˆœí•˜ê²Œ í† í°ì„ í—¤ë”ì— ë‹´ì•„ ìš”ì²­í•˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n1. ë¡œê·¸ì¸ì„ í†µí•´ tokenì„ ì„œë²„ì—ì„œ ì–»ëŠ”ë‹¤.\n2. tokenì„ ì–´ë”˜ê°€ì— ì €ì¥í•œë‹¤.\n3. ìš”ì²­ë§ˆë‹¤ ì €ì¥í•œ í† í°ì„ í—¤ë”ì— ì¶”ê°€í•˜ì—¬ ì„œë²„ì— ì „ì†¡í•œë‹¤.\n\nì—¬ê¸°ì„œ tokenì„ ì–´ë”˜ê°€ì— ì €ì¥í•´ì•¼ í•˜ëŠ”ë°, ì €ì¥í•  ì¥ì†ŒëŠ” `LocalStorage` ë˜ëŠ” `SessionStorage`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.\n\nê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì´ `Authorization` í—¤ë”ë¥¼ ì¶”ê°€í•˜ì—¬ ìš”ì²­ì„ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.\n\n```js\nconst credentials = localStorage.getItem('credentials');\nfetch(\"/admin/function\", {  \n  method: \"POST\",  \n  headers: {  \n    \"Authorization\": `Bearer ${credentials}`,\n    \"Content-Type\": \"application/json\"  \n  },  \n  body: JSON.stringify(...)  \n})\n```\n\nì½”ë“œë§Œ ë³¸ë‹¤ë©´ ì €ì¥ëœ í† í°ì„ êº¼ë‚´ëŠ” ì‘ì—…ê³¼ í—¤ë”ì— í† í°ì„ ì¶”ê°€í•˜ëŠ” ì‘ì—… ì™¸ì—ëŠ” ì „í˜€ ë¬¸ì œê°€ ë  ìƒí™©ì´ë¼ê³  ë³´ì´ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ë³´ì•ˆ ì¸¡ë©´ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n\nLocalStorage ê°™ì€ ì €ì¥ì†Œì— ìˆëŠ” ê°’ë“¤ì€ XSS ê³µê²©ì— ì·¨ì•½í•˜ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.\n\në‹¤ìŒê³¼ ê°™ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ì €í¬ ì„œë¹„ìŠ¤ì—ì„œ ì œê³µëœ í† í°ì„ ì‰½ê²Œ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```js\nlocalStorage.getItem('credentials');\n```\n\ní•˜ì§€ë§Œ ì¿ í‚¤ ë˜í•œ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ì‰½ê²Œ XSS ê³µê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\në‹¤ìŒê³¼ ê°™ì€ í•œ ì¤„ë¡œ ì¿ í‚¤ì˜ ëª©ë¡ì„ ì „ë¶€ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```js\ndocument.cookie;\n```\n\ní•˜ì§€ë§Œ ì¿ í‚¤ì˜ ê²½ìš° `HttpOnly`ë¼ëŠ” í”Œë˜ê·¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n\ní•´ë‹¹ í”Œë˜ê·¸ë¥¼ ì„¤ì •í•˜ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, LocalStorage ë³´ë‹¤ ì•ˆì „í•˜ê²Œ í† í°ì„ ë³´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në˜í•œ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ë©´ ë§¤ ìš”ì²­ ì‹œ í† í°ì„ êº¼ë‚´ê³  í—¤ë”ì— ì¶”ê°€í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ê°œë°œì˜ í¸ì˜ì„± ë˜í•œ ë†’ìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ ì´ëŸ¬í•œ ìƒí™©ìœ¼ë¡œ ì¸í•´ í—¤ë”ë¥¼ ì‚¬ìš©í•œ ë°©ë²•ì´ ì•„ë‹Œ, ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ ë°©ë²•ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.\n\n---\n### ê¸°ì¡´ì˜ ì¸ì¦ ë°©ì‹\n\nê¸°ì¡´ì˜ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n```java\n@Component\npublic class LoginMemberResolver implements HandlerMethodArgumentResolver {\n\n    private static final String BEARER_TOKEN_PREFIX = \"Bearer \";\n\n    private final AuthExtractor authExtractor;\n\n    public LoginMemberResolver(AuthExtractor authExtractor) {\n        this.authExtractor = authExtractor;\n    }\n\n    @Override\n    public boolean supportsParameter(MethodParameter parameter) {\n        return parameter.getParameterType().equals(LoginMember.class) && parameter.hasParameterAnnotation(Login.class);\n    }\n\n    @Override\n    public LoginMember resolveArgument(...) {\n        String header = webRequest.getHeader(HttpHeaders.AUTHORIZATION);\n        String token = extractToken(header);\n        AuthPayload authPayload = authExtractor.extract(token);\n        return new LoginMember(authPayload.getMemberId());\n    }\n\n    private String extractToken(String header) {\n        validateHeader(header);\n        return header.substring(BEARER_TOKEN_PREFIX.length()).trim();\n    }\n\n    private void validateHeader(String header) {\n        if (header == null) {\n            throw new UnauthorizedException(...);\n        }\n        if (!header.toLowerCase().startsWith(BEARER_TOKEN_PREFIX.toLowerCase())) {\n            throw new UnauthorizedException(...);\n        }\n    }\n}\n```\n\nì´ë•ŒëŠ” ì—­í• ì´ë¼ëŠ” ë„ë©”ì¸ì´ ì—†ê³  ë‹¨ìˆœíˆ ì‚¬ìš©ìì— ëŒ€í•œ ì¸ì¦ë§Œ ìˆì—ˆê¸° ë•Œë¬¸ì— `ArgumentResolver`ë¡œ ì¸ì¦ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì— `@Login` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì´ë©´ í•´ë‹¹ í•¸ë“¤ëŸ¬ì— ì¸ì¦ ê¸°ëŠ¥ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.\n\n```java\n@GetMapping(\"/profile\")\npublic ResponseEntity<MemberProfileResponse> findMemberProfile(@Login LoginMember loginMember) {\n    ...\n}\n```\n### ì¶”ê°€ëœ ê¸°ëŠ¥, ë°œìƒí•œ ë¬¸ì œì \n\nì§€ê¸ˆê¹Œì§€ ê´€ë¦¬ì ì›¹ í˜ì´ì§€ì— ì ‘ì†í•  ë•Œ ì¸ì¦, ì¸ê°€ ì‘ì—… ì—†ì´ ëˆ„êµ¬ë‚˜ ì ‘ì†ì´ ê°€ëŠ¥í–ˆê¸° ë•Œë¬¸ì— ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í–ˆìŠµë‹ˆë‹¤.\n\nìœ„ì—ì„œ ì„¤ëª…í–ˆë“¯, ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ì€ í—¤ë”ê°€ ì•„ë‹Œ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ê¸°ì¡´ì˜ ì¸ì¦ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” `LoginMemberResolver`ì—ëŠ” í—¤ë”ë¥¼ í†µí•œ ì¸ì¦ë§Œ ë˜ë„ë¡ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@Component\npublic class LoginMemberResolver implements HandlerMethodArgumentResolver {\n    ...\n    @Override\n    public LoginMember resolveArgument(...) {\n        String header = webRequest.getHeader(HttpHeaders.AUTHORIZATION);\n        String token = extractToken(header);\n        AuthPayload authPayload = authExtractor.extract(token);\n        return new LoginMember(authPayload.getMemberId());\n    }\n    ...\n}\n```\n\në”°ë¼ì„œ ê´€ë¦¬ìì˜ ì¸ì¦ì€ ê¸°ì¡´ì˜ `LoginMemberResolver`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê³  ìƒˆë¡œìš´ `ArgumentResolver`ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n```java\n@Component\npublic class LoginAdminResolver implements HandlerMethodArgumentResolver {\n    ...\n    @Override\n    public LoginMember resolveArgument(...) {\n        Cookie[] cookies = request.getCookies();\n        String token = extractToken(cookies);\n        AuthPayload authPayload = authExtractor.extract(token);\n        if (authPayload.getRole() != Role.ADMIN) {\n            throw new ForbiddenException(...);\n        }\n        return new LoginMember(authPayload.getId());\n    }\n}\n```\n\nê·¸ëŸ¬ë©´ ì´ì œ ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ `@LoginAdmin` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê´€ë¦¬ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@PostMapping(\"/festivals\")\npublic ResponseEntity<Void> createFestival(@Admin LoginMember loginMember,\n                                           @RequestBody FestivalCreateRequest request) {\n    festivalService.create(request);  \n    return ResponseEntity.ok()\n        .build();\n}\n```\n\nì´ë ‡ê²Œ ì—¬ëŸ¬ ì‚¬ìš©ìì— ëŒ€í•œ ì¸ì¦ê³¼ ì¸ê°€ ì‘ì—…ì´ ëë‚¬ì„ê¹Œìš”..?\n\nì•ˆíƒ€ê¹ê²Œë„ ì—¬ê¸°ì—ëŠ” ì—¬ëŸ¬ ë¬¸ì œì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\n#### í•„ìš”í•˜ì§€ ì•Šì€ íŒŒë¼ë¯¸í„°\n\n`createFestival` í•¸ë“¤ëŸ¬ ë©”ì„œë“œì—ì„œ `LoginMember` íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì´ ì—†ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¸ì¦ì„ ìœ„í•´ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ì— LoginMember íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.\n#### ì •ì  íŒŒì¼ì— ëŒ€í•œ ì¸ì¦\n\nì¸ì¦ ì‘ì—…ì„ `ArgumentResolver`ì—ì„œ ìˆ˜í–‰í•˜ë¯€ë¡œ, í•¸ë“¤ëŸ¬ ë©”ì„œë“œë¡œ ì§€ì •ëœ ê²½ë¡œë§Œ ì¸ì¦ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\në”°ë¼ì„œ ì •ì  íŒŒì¼ì— ëŒ€í•œ ì¸ì¦ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ ê´€ë¦¬ì ì›¹ í˜ì´ì§€ì˜ JS íŒŒì¼ì´ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n> ì–´ì°¨í”¼ JS íŒŒì¼ì„ ì—´ì–´ë³´ë”ë¼ë„ ì¸ì¦ì´ ë˜ì§€ ì•Šìœ¼ë©´ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ê¸´ í•˜ë‚˜, ê´€ë¦¬ìì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ë…¸ì¶œëœë‹¤ëŠ” ì ì´ ë³´ì•ˆ ì¸¡ë©´ì—ì„œ ì·¨ì•½í•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.\n### ì–´ë–»ê²Œ í•´ê²°í•  ê²ƒì¸ê°€?\n\nì§€ê¸ˆê¹Œì§€ì˜ ìƒí™©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n![](images/20230822151035.png)\n![](images/20230822151040.png)\n![](images/20230822151045.png)\n\në”°ë¼ì„œ ë¬¸ì œì ì„ í•´ê²°í•˜ë ¤ë©´, `ArgumentResolver`ë¡œ ì¸ì¦ì„ í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ `Interceptor`ë¡œ íŠ¹ì • ê²½ë¡œì— ëŒ€í•œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ë©´ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n> ì—¬ê¸°ì„œ `Interceptor`ëŠ”  `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ ë§í•©ë‹ˆë‹¤.\n\n`Interceptor`ë¥¼ ì‚¬ìš©í•˜ë©´ ìš”ì²­ê³¼ ì‘ë‹µì„ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në˜í•œ `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ì—ëŠ” ì„¸ ê°œì˜ default ë©”ì„œë“œê°€ ìˆìŠµë‹ˆë‹¤.\n\n```java\ndefault boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {  \n   return true;  \n}\n\ndefault void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable ModelAndView modelAndView) throws Exception { \n}\n\ndefault void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, @Nullable Exception ex) throws Exception {  \n}\n```\n\nì´ ì¤‘ì—ì„œ ì €í¬ê°€ ë´ì•¼í•  ë©”ì„œë“œëŠ” `preHandle()` ì…ë‹ˆë‹¤.\n\n`preHandle()` ë©”ì„œë“œëŠ” ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ì‹¤í–‰ë˜ëŠ” ë©”ì„œë“œë¡œ, í•´ë‹¹ ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ì—¬ ìš”ì²­ì´ í•¸ë“¤ëŸ¬ ë©”ì„œë“œë¡œ ë„˜ì–´ê°€ê¸° ì „ì— ì¸ì¦ ê³¼ì •ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n`HandlerInterceptor`ë¥¼ êµ¬í˜„í•œ InterceptorëŠ” ë‹¤ìŒê³¼ ê°™ì´ `WebMvcConfigurer`ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì— `addInterceptors()` ë©”ì„œë“œë¥¼ ì¬ì •ì˜ í•œ ë’¤ `registry` íŒŒë¼ë¯¸í„°ì— ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.\n\n```java\n@Configuration\npublic class WebConfig implements WebMvcConfigurer {\n    ...\n    @Override  \n    public void addInterceptors(InterceptorRegistry registry) {  \n        registry.addInterceptor(adminAuthInterceptor())  \n            .addPathPatterns(\"/admin/**\", \"/js/admin/**\")  \n            .excludePathPatterns(\"/admin/login\");  \n        registry.addInterceptor(memberAuthInterceptor())\n            .addPathPatterns(\"/members/**\");\n    }\n\n    @Bean  \n    public HandlerInterceptor adminAuthInterceptor() {  \n        return new AuthInterceptor(Role.ADMIN, authExtractor);\n    }  \n      \n    @Bean  \n    public HandlerInterceptor memberAuthInterceptor() {  \n        return new AuthInterceptor(Role.MEMBER, authExtractor);\n    }\n}\n```\n#### Interceptor\n\nê¸°ì¡´ì˜ `ArgumentResolver`ì—ì„œëŠ” ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒê³¼ í† í°ì„ `AuthExtractor`ì— ì „ë‹¬í•˜ì—¬ `LoginMember`ë¥¼ ë°˜í™˜í•˜ëŠ” ë‘ ê°€ì§€ì˜ ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì±…ì„ì„ Interceptorë¡œ ìœ„ì„í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\nê·¸ëŸ°ë° ì‚¬ìš©ìì™€ ê´€ë¦¬ìëŠ” í† í°ì„ ë³´ë‚´ëŠ” ë°©ì‹ì´ ë‹¬ë¼ì„œ, ì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œë¥¼ ë¶„ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.\n\n```java\npublic class AuthInterceptor implements HandlerInterceptor {\n\n    private final Role role;\n    private final AuthExtractor authExtractor;\n    \n    @Override  \n    public boolean preHandle(...) throws Exception {\n        String token;\n        if (role == Role.MEMBER) {\n            token = getHeaderToken(request);\n        }\n        if (role == Role.ADMIN) {\n            token = getCookieToken(request);\n        }\n        if (token == null) {\n            throw new UnauthorizedException(...);\n        }\n        AuthPayload authPayload = authExtractor.extract(token);\n        ...\n    }\n}\n```\n\ní•˜ì§€ë§Œ ì´ ë°©ë²•ì€ ìƒˆë¡œìš´ ì—­í• ì´ ì¶”ê°€ëœë‹¤ë©´ ì¡°ê±´ë¬¸ì´ ì¶”ê°€ë¡œ ìƒê¸°ê²Œ ë  ê²ƒì´ê³  í•œëˆˆì— ë´ë„ ì´ ë°©ë²•ì€ ì© ìœ ì¾Œí•˜ì§€ ì•Šì•„ ë³´ì…ë‹ˆë‹¤.\n#### ì„œë¡œ ë‹¤ë¥¸ ì¸ì¦ ë°©ì‹\n\nìœ„ì˜ êµ¬í˜„ì—ì„œëŠ” ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì„ ì—­í• ì— ë”°ë¼ êµ¬ì²´ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\nì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì´ ë‹¤ë¥¸ ê²ƒì€ ë§ì§€ë§Œ, êµ³ì´ ì—­í• ì— ë”°ë¼ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì„ ë¶„ë¦¬í•  í•„ìš”ê°€ ìˆì„ê¹Œìš”?\n\nì´ê²ƒì„ í•˜ë‚˜ì˜ ì±…ì„ìœ¼ë¡œ ë³¸ë‹¤ë©´ ë‹¤ë¥¸ ê°ì²´ê°€ ì´ê²ƒì„ ë‹´ë‹¹í•˜ê²Œ í•˜ëŠ” ê²ƒì„ ìƒê°í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic interface TokenExtractor {\n    Optional<String> extract(HttpServletRequest request);\n}\n```\n\nê·¸ë¦¬ê³  `TokenExtractor`ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë‘ ê°œì˜ êµ¬í˜„ì²´ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.\n\n```java\npublic class CookieTokenExtractor implements TokenExtractor {\n    ...\n}\n\npublic class HeaderTokenExtractor implements TokenExtractor {\n    ...\n}\n```\n\nì´ì œ ìš”ì²­ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì„ `TokenExtractor`ì— ìœ„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic class AuthInterceptor implements HandlerInterceptor {\n    ...\n    private final TokenExtractor tokenExtractor;\n\n    @Override  \n    public boolean preHandle(...) throws Exception {\n        String token = tokenExtractor.extract(request)\n            .orElseThrow(() -> new UnauthorizedException(...));\n        AuthPayload authPayload = authExtractor.extract(token);\n        if (authPayload.getRole() != role) {\n            throw new ForbiddenException(...);\n        }\n        return true; // boolean..?\n    }\n}\n```\n\nê·¸ëŸ°ë° `preHandle()` ë©”ì„œë“œì˜ ë°˜í™˜ íƒ€ì…ì€ booleanì¸ë°, ì–´ë–»ê²Œ AuthPayloadì— ìˆëŠ” ê°’ì„ í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆì„ê¹Œìš”?\n#### HandlerInterceptor -> ArgumentResolver\n\n`preHandle()` ë©”ì„œë“œë¡œ ë„˜ì–´ì˜¤ëŠ” `HttpServletRequest` ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ì„œë“œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n\n```java\nObject getAttribute(String name);\n\nvoid setAttribute(String name, Object o);\n```\n\në”°ë¼ì„œ Interceptorì—ì„œ ì¸ì¦ì´ ëë‚˜ê³  ë°˜í™˜ëœ `AuthPayload` ê°ì²´ë¥¼ `setAttribute()` ë©”ì„œë“œë¥¼ í†µí•´ `ArgumentResolver`ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic class AuthInterceptor implements HandlerInterceptor {\n\n    @Override  \n    public boolean preHandle(...) throws Exception {\n        String token = tokenExtractor.extract(request)\n            .orElseThrow(() -> new UnauthorizedException(...));\n        AuthPayload authPayload = authExtractor.extract(token);\n        request.setAttribute(AuthPayload.class.getName(), authPayload);\n        return true;\n    }\n}\n```\n\nì´ì œ `ArgumentResolver`ëŠ” WebRequest ê°ì²´ì˜  `getAttribute()` ë©”ì„œë“œë¥¼ í†µí•´ `AuthPayload`ë¥¼ êº¼ë‚¸ ë’¤, í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ íŒŒë¦¬ë¯¸í„°ì— ê°’ì„ ë§¤í•‘í•˜ë©´ ë©ë‹ˆë‹¤.\n\n> Attributeì˜ keyê°€ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, `AuthPayload.class.getName()`ê³¼ ê°™ì´ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ê³ ìœ í•œ íŒ¨í‚¤ì§€ ëª…ê³¼ í´ë˜ìŠ¤ ëª…ì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ë¬¸ì œë¥¼ í•´ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n```java\npublic class AuthArgumentResolver implements HandlerMethodArgumentResolver {\n    ...\n    @Override  \n    public LogimMember resolveArgument(...) throws Exception {  \n        AuthPayload authPayload = getAuthPayload(webRequest);\n        return new LoginMember(authPayload.getId()); \n    }\n\n    private AuthPayload getAuthPayload(NativeWebRequest request) {\n        AuthPayload authPayload = (AuthPayload) request.getAttribute(AuthPayload.class.getName(), RequestAttributes.SCOPE_REQUEST);  \n        if (authPayload == null) {  \n            return AuthPayload.ANONYMOUS; // new AuthPayload(null, Role.ANONYMOUS); \n        }  \n        return authPayload;\n    }\n}\n```\n\në”°ë¼ì„œ ì´ì œë¶€í„° ì‚¬ìš©ìê°€ ì ‘ì†í•˜ëŠ” ê²½ë¡œì— ë”°ë¼ ì¸ì¦ê³¼ ì¸ê°€ ê¸°ëŠ¥ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.\n![](images/20230822170744.png)\n### ì¸ì¦ ì¸ê°€ í…ŒìŠ¤íŠ¸\n\nê·¸ë ‡ë‹¤ë©´ ì´ì œ ëª¨ë“  ê¸°ëŠ¥ì„ ì œì‘í–ˆìœ¼ë‹ˆ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì•¼ê² ì£ ?\n\nê´€ë¦¬ì í˜ì´ì§€ë¥¼ ì ‘ì†í•  ë•Œ, ê´€ë¦¬ì ê¶Œí•œì´ ì•„ë‹Œ ì‚¬ìš©ìë©´ 401 ìƒíƒœì½”ë“œê°€ ë°˜í™˜ë˜ëŠ” ê²ƒì„ ê²€ì¦í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.\n\n```java\n@WebMvcTest(AdminController.class)\nclass AdminControllerTest {\n    @Test\n    void í† í°ì˜_Roleì´_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  \n        // when & then  \n        mockMvc.perform(get(\"/admin\")  \n                .cookie(new Cookie(\"token\", \"token\")))  \n            .andExpect(status().isUnauthorized());  \n    }\n}\n```\n\ní•´ë‹¹ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë‹¹ì—°í•˜ê²Œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.\n\nì™œëƒí•˜ë©´ `Interceptor` í•„ë“œì˜ `AuthExtractor`ê°€ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\n\në˜í•œ `AuthExtractor`ëŠ” ì¸í„°í˜ì´ìŠ¤ì´ê³ , í•´ë‹¹ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” JWT í† í°ìœ¼ë¡œ ì¸ì¦ì„ í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ Mockitoì˜ `@MockBean` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ê±°ë‚˜, í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì—ì„œ `@Import` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ `AuthExtractor`ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ ë©ë‹ˆë‹¤.\n\n```java\n@Import(FakeAuthExtractor.class) // Fake\n@WebMvcTest(AdminController.class)\nclass AdminControllerTest {\n\n    @MockBean\n    AuthExtractor authExtractor; // Mock\n}\n```\n\nê·¸ëŸ°ë° ì´ë ‡ê²Œ Fake ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, Mock ê°ì²´ë¥¼ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n#### Fake ì‚¬ìš©ì˜ ë¬¸ì œ\n\n`FakeAuthExtractor` í´ë˜ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„ë©ë‹ˆë‹¤.\n\n```java\npublic class FakeAuthExtractor implements AuthExtractor {\n    @Override  \n    public AuthPayload extract(String token) {  \n        if (Objects.equals(token, \"member\")) {\n            return new AuthPayload(1L, Role.MEMBER);\n        }\n        if (Objects.equals(token, \"admin\")) {\n            return new AuthPayload(1L, Role.ADMIN);  \n        }\n        return AuthPayload.ANONYMOUS;\n    }\n}\n```\n\nJWT í† í°ì„ ì§ì ‘ íŒŒì‹±í•˜ì—¬, AuthPayload ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ í•„ìš”ëŠ” ì—†ìœ¼ë‹ˆ ë‹¨ìˆœíˆ í•˜ë“œì½”ë”©ëœ ê°’ìœ¼ë¡œ AuthPayload ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ í•´ë‹¹ Fake ê°ì²´ì˜ ë¬¸ì œì ì€ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ `FakeAuthExtractor`ì˜ êµ¬í˜„ ì‚¬í•­ì— ì˜ì¡´ì ìœ¼ë¡œ ë³€í•˜ê²Œ ë©ë‹ˆë‹¤.\n\n```java\nmockMvc.perform(get(\"/admin\")  \n        .cookie(new Cookie(\"token\", \"member\"))) // ìƒˆë¡œìš´ ì—­í• ì´ ìƒê¸°ë©´ FakeAuthExtractorë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤!\n    .andExpect(status().isUnauthorized());  \n```\n#### Mock ì‚¬ìš©ì˜ ë¬¸ì œ\n\nMockitoë¥¼ ì‚¬ìš©í•˜ë©´ Stub ê°ì²´ë¥¼ ë§¤ìš° ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ Stubì´ í•„ìš”í•œ ë©”ì„œë“œë§ˆë‹¤  `given()`ê³¼ ê°™ì´ ëª¨ì˜ ë™ì‘ì„ ì •ì˜í•´ ì¤˜ì•¼ í•˜ëŠ” ì¤‘ë³µ ì½”ë“œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n\n```java\n@Test\nvoid test1() {  \n    // given\n    given(authExtractor.extract(anyString()))    \n        .willReturn(new AuthPayload(1L, Role.MEMBER));\n    ...\n}\n\n@Test\nvoid test2() {  \n    // given\n    given(authExtractor.extract(anyString()))    \n        .willReturn(new AuthPayload(1L, Role.ADMIN));\n    ...\n}\n```\n\n#### ê³µí†µì ì¸ ë¬¸ì œì \n\nê²°êµ­ Fake ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë˜, Mock ê°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë“  ê°„ì— í…ŒìŠ¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë ¤ë©´ `AuthExtrator` ë¹ˆì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në”°ë¼ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë§ˆë‹¤ í•´ë‹¹ ê°ì²´ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì½”ë“œë¥¼ ë§¤ë²ˆ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.\n\n```java\n@Import(FakeAuthExtractor.class) \n\n// ë˜ëŠ”\n\n@MockBean\nAuthExtractor authExtractor;\n```\n\nì´ëŸ¬í•œ ë¬¸ì œì ì€  `@WebMvcTest` í…ŒìŠ¤íŠ¸ì—ì„œ, MVC ê´€ë ¨ ë¹ˆë“¤ë§Œ ë¶ˆëŸ¬ì˜¤ê¸° ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.\n\n```java\n@TypeExcludeFilters(WebMvcTypeExcludeFilter.class) <--\n...\npublic @interface WebMvcTest {\n    ...\n}\n```\n\n`WebMvcTypeExcludeFilter` í´ë˜ìŠ¤ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ íŠ¹ì • ë¹ˆë“¤ë§Œ ë“±ë¡í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic final class WebMvcTypeExcludeFilter extends StandardAnnotationCustomizableTypeExcludeFilter<WebMvcTest> {\n    ...\n    static {  \n       Set<Class<?>> includes = new LinkedHashSet<>();  \n       includes.add(ControllerAdvice.class);  \n       includes.add(JsonComponent.class);  \n       includes.add(WebMvcConfigurer.class);  \n       includes.add(WebMvcRegistrations.class);  \n       includes.add(jakarta.servlet.Filter.class);  \n       includes.add(FilterRegistrationBean.class);  \n       includes.add(DelegatingFilterProxyRegistrationBean.class); \n       includes.add(HandlerMethodArgumentResolver.class);  \n       includes.add(HttpMessageConverter.class);  \n       includes.add(ErrorAttributes.class);  \n       includes.add(Converter.class);  \n       includes.add(GenericConverter.class);  \n       includes.add(HandlerInterceptor.class);\n       ...\n   }\n}\n```\n\nê·¸ë ‡ë‹¤ë©´ í•´ê²°ë²•ì€ ìƒê°ë³´ë‹¤ ë‹¨ìˆœí•©ë‹ˆë‹¤.\n\n`@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ í™•ì¥í•œ ì»¤ìŠ¤í…€ `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.\n\n```java\n@WebMvcTest  \n@Import(TestAuthConfig.class)  \n@Retention(RetentionPolicy.RUNTIME)  \npublic @interface CustomWebMvcTest {  \n  \n    @AliasFor(\"controllers\")  \n    Class<?>[] value() default {};  \n  \n    @AliasFor(\"value\")  \n    Class<?>[] controllers() default {};  \n}\n```\n\n`@WebMvcTest`ì—ëŠ” ì†ì„±ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í´ë˜ìŠ¤ë¥¼ ì ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.\n\në§Œì•½ ì ì–´ì£¼ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë¹ˆìœ¼ë¡œ ì£¼ì…í•˜ë‹ˆ, `NoSuchBeanDefinitionException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ë¯€ë¡œ íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë¥¼ ì ì–´ì£¼ê¸° ìœ„í•´ ê¸°ì¡´ `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì— ìˆë˜ íŒŒë¼ë¯¸í„°ë“¤ì„ ì ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.\n\nê·¸ë¦¬ê³  `@Import` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ `TestAuthConfig` í´ë˜ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ì£¼ì…í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n`TestAuthConfig` í´ë˜ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n```java\n@TestConfiguration  \npublic class TestAuthConfig {\n\n    @Bean\n    public AuthExtractor authExtractor() {\n        // return Mockito.mock(AuthExtractor.class);\n        return new FakeAuthExtractor();\n    }\n}\n```\n\nì´ì œ `@CustomWebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤!\n\n```java\n@CustomWebMvcTest(AdminController.class)\nclass AdminControllerTest {\n    @Test\n    void í† í°ì˜_Roleì´_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  \n        // when & then  \n        mockMvc.perform(get(\"/admin\")  \n                .cookie(new Cookie(\"token\", \"token\")))  \n            .andExpect(status().isUnauthorized());  \n    }\n}\n```\n### ì—¬ì „í•œ ë¬¸ì œì \n\ní•˜ì§€ë§Œ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì§€ìš°ê¸´ í–ˆì–´ë„ ì—¬ì „íˆ ê·¼ë³¸ì ì¸ ë¬¸ì œëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.\n\nFakeë¥¼ ì‚¬ìš©í•  ê²ƒì´ëƒ, Mockì„ ì‚¬ìš©í•  ê²ƒì´ëƒì…ë‹ˆë‹¤.\n\nFakeë¥¼ ì‚¬ìš©í•œë‹¤ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ Fakeì˜ ë™ì‘ì— ì¢…ì†ì ìœ¼ë¡œ ë˜ê³ , Mockì„ ì‚¬ìš©í•œë‹¤ë©´ ë§¤ë²ˆ ëª¨ì˜ ë™ì‘ì„ ì •ì˜í•´ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.\n\ní•´ë‹¹ í…ŒìŠ¤íŠ¸ì˜ í•µì‹¬ì€ ì¸ì¦ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì¸ì¦ì´ ëœ ì‚¬ìš©ìë§Œ ìš”ì²­ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\n\në”°ë¼ì„œ ì¸ì¦ì˜ êµ¬ì²´ì ì¸ ë°©ë²•ì€ ì¤‘ìš”í•˜ì§€ ì•Šê³ , ê²½ë¡œì— ë”°ë¼ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€, í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ì™€ ì¸ê°€ëœ ì‚¬ìš©ìë¥¼ êµ¬ë¶„ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.\n\nê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ ì´ëŸ° ì‘ì—…ì„ ì¤‘ë³µëœ ì½”ë“œ ì—†ì´ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì„ê¹Œìš”?\n#### TestExecutionListener\n\nìŠ¤í”„ë§ì€ ë‹¤ìŒê³¼ ê°™ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\n\n```java\npublic interface TestExecutionListener {\n    default void beforeTestClass(TestContext testContext) throws Exception {};\n    default void prepareTestInstance(TestContext testContext) throws Exception {};\n    default void beforeTestMethod(TestContext testContext) throws Exception {};\n    default void afterTestMethod(TestContext testContext) throws Exception {};\n    default void afterTestClass(TestContext testContext) throws Exception {};\n}\n```\n\ní•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ, ì „ì²˜ë¦¬ ê³¼ì •ì„ ìˆ˜í–‰í•  ë©”ì„œë“œë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì— ë“±ë¡ì‹œí‚¤ë©´ ì¤‘ë³µëœ ì½”ë“œë¥¼ ì—†ì•¨ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në‹¤ìŒê³¼ ê°™ì´ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ì–´, ì¸ì¦ì´ í•„ìš”í•œ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë§ˆë‹¤ ì ìš©ì„ í•œë‹¤ë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\n```java\n@Retention(RetentionPolicy.RUNTIME)  \n@Target(ElementType.METHOD)  \npublic @interface WithMockAuth {  \n  \n    long id() default 1;  \n  \n    Role role() default Role.MEMBER;  \n}\n```\n\n```java\n@Test\nvoid ì‚¬ìš©ìê°€_ë¡œê·¸ì¸ì„_í•˜ì§€_ì•Šìœ¼ë©´_ì•„ë‹ˆë©´_401() throws Exception {  \n    // when & then  \n    mockMvc.perform(get(\"/admin\")  \n            .cookie(new Cookie(\"token\", \"token\")))  \n        .andExpect(status().isUnauthorized());  \n}\n\n@Test\n@WithMockAuth(role = Role.MEMBER)\nvoid ì‚¬ìš©ìê°€_ì–´ë“œë¯¼ì´_ì•„ë‹ˆë©´_401() throws Exception {  \n    // when & then  \n    mockMvc.perform(get(\"/admin\")  \n            .cookie(new Cookie(\"token\", \"token\")))  \n        .andExpect(status().isUnauthorized());  \n}\n\n@Test\n@WithMockAuth(role = Role.ADMIN)\nvoid ì‚¬ìš©ìê°€_ì–´ë“œë¯¼_ì´ë©´_200() throws Exception {  \n    // when & then  \n    mockMvc.perform(get(\"/admin\")  \n            .cookie(new Cookie(\"token\", \"token\")))  \n        .andExpect(status().ikOk());  \n}\n```\n\ní•˜ì§€ë§Œ ì–´ë–»ê²Œ êµ¬í˜„ì„ í•´ì•¼í• ê¹Œìš”?\n#### TestExecutionListener êµ¬í˜„\n\nì ê¹ `AuthInterceptor`ì˜ `preHandle()` ë©”ì„œë“œë¥¼ ë³´ê² ìŠµë‹ˆë‹¤.\n\n```java\n@Override  \npublic boolean preHandle(...) throws Exception {\n    String token = tokenExtractor.extract(request)\n        .orElseThrow(() -> new UnauthorizedException(...));\n    AuthPayload authPayload = authExtractor.extract(token);\n    if (authPayload.getRole() != role) {\n        throw new ForbiddenException(...);\n    }\n    request.setAttribute(AuthPayload.class.getName(), authPayload);\n    return true;\n}\n```\n\nì¸ì¦, ì¸ê°€ì— ëŒ€í•œ ê°€ì¥ í° í•µì‹¬ì ì¸ ë¶€ë¶„ì€ `AuthExtractor` í´ë˜ìŠ¤ì˜ `extract()` ë©”ì„œë“œ ì…ë‹ˆë‹¤.\n\nê·¸ë ‡ë‹¤ë©´ `TestExecutionListener`ë¥¼ ì‚¬ìš©í•´ì„œ í…ŒìŠ¤íŠ¸ê°€ ìˆ˜í–‰ë˜ê¸° ì „ ì „ì²˜ë¦¬ ì‘ì—…ì„ í†µí•´ì„œ `extract()` ë©”ì„œë“œì˜ ë°˜í™˜ ê°’ì„ ì¡°ì‘í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\n`TestExecutionListener`ì˜ ì¶”ìƒ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì—ëŠ” ê³µí†µìœ¼ë¡œ `TestContext` ê°ì²´ê°€ ì œê³µë©ë‹ˆë‹¤.\n\n`TestContext` ê°ì²´ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic interface TestContext extends AttributeAccessor, Serializable {\n    ...\n    Method getTestMethod();\n    ...\n    ApplicationContext getApplicationContext();\n    ...\n}\n```\n\n`getTestMethod()` ë©”ì„œë“œë¡œ ì œê³µë˜ëŠ” `Method` ê°ì²´ì—ëŠ” ë©”ì†Œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , í•´ë‹¹ ì–´ë…¸í…Œì´ì…˜ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œê°€ ì œê³µë©ë‹ˆë‹¤.\n\n```java\npublic boolean isAnnotationPresent(Class<? extends Annotation> annotationClass) {  \n    return super.isAnnotationPresent(annotationClass);  \n}\n\npublic <T extends Annotation> T getDeclaredAnnotation(Class<T> annotationClass) {  \n    return this.getAnnotation(annotationClass);  \n}\n```\n\në”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n1. í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì— íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.\n2. íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì„ ê°€ì ¸ì˜¨ë‹¤.\n3. ApplicationContext ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ ë’¤, AuthExtractor ë¹ˆì„ êº¼ë‚¸ë‹¤.\n4. AuthExtractorê°€ íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì˜ ì†ì„±ìœ¼ë¡œ ì •ì˜ëœ í•„ë“œë¥¼ ë°˜í™˜í•˜ë„ë¡ í•œë‹¤.\n\ní…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  `AuthExtractor` ê°ì²´ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\n```java\npublic class MockAuthExtractor implements AuthExtractor {  \n  \n    private Long memberId = null;  \n    private Role role = Role.ANONYMOUS;  \n  \n    public void setMemberId(Long memberId) {  \n        this.memberId = memberId;  \n    }  \n  \n    public void setRole(Role role) {  \n        this.role = role;  \n    }  \n  \n    @Override  \n    public AuthPayload extract(String token) {  \n        return new AuthPayload(memberId, role);  \n    }  \n}\n```\n\nê·¸ë¦¬ê³  `TestExecutionListener`ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì—ì„œ `beforeTestMethod()` ë©”ì„œë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\në˜í•œ í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ê°€ ì˜í–¥ì„ ë°›ì§€ ì•Šì•„ì•¼ í•˜ë¯€ë¡œ, `afterTestMethod()` ë©”ì„œë“œë„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.\n\n```java\npublic class MockAuthTestExecutionListener implements TestExecutionListener {  \n  \n    @Override  \n    public void beforeTestMethod(TestContext testContext) throws Exception {  \n        Method testMethod = testContext.getTestMethod();  \n        if (testMethod.isAnnotationPresent(WithMockAuth.class)) {  \n            WithMockAuth withMockAuth = testMethod.getDeclaredAnnotation(WithMockAuth.class);  \n            ApplicationContext applicationContext = testContext.getApplicationContext();  \n            MockAuthExtractor authExtractor = applicationContext.getBean(MockAuthExtractor.class);  \n            authExtractor.setMemberId(withMockAuth.id());  \n            authExtractor.setRole(withMockAuth.role());  \n        }  \n    }\n\n    @Override  \n    public void afterTestMethod(TestContext testContext) throws Exception { \n        ApplicationContext applicationContext = testContext.getApplicationContext();  \n        MockAuthExtractor authExtractor = applicationContext.getBean(MockAuthExtractor.class);  \n        authExtractor.setMemberId(null);  \n        authExtractor.setRole(Role.ANONYMOUS);  \n    }\n}\n```\n\nê·¸ë¦¬ê³  ì´ì „ì— ë§Œë“¤ì—ˆë˜ `@CustomWebMvcTest`ì— `TestExecutionListener`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•˜ë©´ ëª¨ë“  ì‘ì—…ì´ ëë‚©ë‹ˆë‹¤.\n\n```java\n@WebMvcTest  \n@Import(TestAuthConfig.class)  \n@Retention(RetentionPolicy.RUNTIME)  \n@TestExecutionListeners(MockAuthTestExecutionListener.class) <--\npublic @interface CustomWebMvcTest {\n    ...\n}\n```\n\ní•˜ì§€ë§Œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©° í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.\n\n```java\njava.lang.NullPointerException: Cannot invoke \"com.festago.application.StageService.create(com.festago.dto.StageCreateRequest)\" because \"this.stageService\" is null\n```\n\nì™œëƒí•˜ë©´ `@WebMvcTest`ë¥¼ ìˆ˜í–‰í•  ë•Œ, ê¸°ë³¸ì ìœ¼ë¡œ ë“±ë¡ëœ `TestExecutionListener`ê°€ ìˆëŠ”ë° `@TestExecutionListeners`ë¥¼ ìƒˆë¡­ê²Œ ì‚¬ìš©í•˜ë©´ì„œ ê¸°ì¡´ì˜ `TestExecutionListener`ê°€ ëŒ€ì²´ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\n\në”°ë¼ì„œ ìƒˆë¡œìš´ `TestExecutionListener`ë¥¼ ë“±ë¡í•˜ë©´ì„œ ê¸°ì¡´ì˜ `TestExecutionListener`ëŠ” ìœ ì§€ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.\n\nì´ê²ƒì€ `@TestExecutionListeners`ì˜ `mergeMode` ì†ì„±ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@TestExecutionListeners(listeners = MockAuthTestExecutionListener.class, mergeMode = MergeMode.MERGE_WITH_DEFAULTS)\n```\n\n`@TestExecutionListeners`ì˜ `mergeMode` ì†ì„±ì˜ ê¸°ë³¸ê°’ì€ `REPLACE_DEFAULTS` ì…ë‹ˆë‹¤.\n\në”°ë¼ì„œ `MERGE_WITH_DEFAULTS` ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ì˜ `TestExecutionListener`ë¥¼ ëŒ€ì²´í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ `TestExecutionListener`ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nì´ì œ ì¸ì¦, ì¸ê°€ê°€ í•„ìš”í•œ í…ŒìŠ¤íŠ¸ì— ë‹¤ìŒê³¼ ê°™ì€ ì–´ë…¸í…Œì´ì…˜ë§Œ ì¶”ê°€ì‹œí‚¤ë©´ ê°„í¸í•˜ê²Œ ì¸ì¦, ì¸ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@CustomWebMvcTest(AuthController.class)\nclass AuthControllerTest {\n    @Test\n    @WithMockAuth(role = Role.ADMIN)\n    void ë©¤ë²„_ê¶Œí•œì´_ì•„ë‹Œë°_íƒˆí‡´í•˜ë©´_ì˜ˆì™¸() throws Exception {\n        mockMvc.perform(delete(\"/auth\")\n                .header(\"Authorization\", \"Bearer token\")\n                .contentType(MediaType.APPLICATION_JSON))\n            .andExpect(status().isNotFound());\n    }\n\n    @Test\n    @WithMockAuth\n    void íšŒì›_íƒˆí‡´ë¥¼_í•œë‹¤() throws Exception {\n        mockMvc.perform(delete(\"/auth\")\n                .header(\"Authorization\", \"Bearer token\")\n                .contentType(MediaType.APPLICATION_JSON))\n            .andExpect(status().isOk());\n    }\n}\n```\n\n## ê²°ë¡ \n\nê¸°ì¡´ì˜ ì¸ì¦ ë°©ì‹ì—ëŠ” í•˜ë‚˜ì˜ ì—­í• ë§Œ ì¡´ì¬í•˜ì—¬, í•˜ë‚˜ì˜ ì¸ì¦ ë°©ì‹ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¨ìˆœí•œ ë°©ì‹ì˜ ì¸ì¦ ê¸°ëŠ¥ë§Œ ìˆ˜í–‰í•˜ë©´ ëìŠµë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ê´€ë¦¬ì ë˜ëŠ” ìŠ¤íƒœí”„ê°™ì´ ë‹¤ì–‘í•œ ì—­í• ì˜ ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì–´ ì¶”ê°€ì ì¸ ì¸ì¦ ë°©ì‹ì´ í•„ìš”í•˜ê²Œ ëìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ ìƒˆë¡œìš´ ì¸ì¦ ë°©ì‹ì´ ì¶”ê°€ ë˜ë”ë¼ë„ í° ë³€ê²½ ì—†ì´ ì¸ì¦ ë° ì¸ê°€ ì‘ì—…ì´ í•„ìš”í•˜ì˜€ê³ , ì¸ì¦, ì¸ê°€ë¥¼ `Interceptor`ì—ì„œ ìˆ˜í–‰í•˜ë„ë¡ í•œ ë’¤, í† í°ì„ ì¶”ì¶œí•˜ê³  í† í°ì—ì„œ ì¸ì¦ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ì±…ì„ì„ ê°€ì§„ ê°ì²´ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„±ì´ ë†’ì€ ì½”ë“œë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.\n\në˜í•œ `@WebMvcTest` í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ì¸ì¦, ì¸ê°€ ì‘ì—…ìœ¼ë¡œ ì¤‘ë³µì ìœ¼ë¡œ ë°œìƒí•˜ê²Œ ë˜ëŠ” ì½”ë“œ ë˜í•œ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ê³¼ `TestExecutionListener`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µëœ ì½”ë“œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në§Œì•½ `Request` ê°ì²´ì˜ `Attribute`ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì§€ ì•Šë‹¤ë©´, `RequestScope` ë²”ìœ„ë¥¼ ê°€ì§„ ë¹ˆì„ ì£¼ì…í•˜ì—¬ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n> `Attribute`ì—ì„œ ê°’ì„ êº¼ë‚¼ ë•Œ Object íƒ€ì…ìœ¼ë¡œ ì¶”ì¶œì´ ë˜ë¯€ë¡œ, í˜•ë³€í™˜ ê³¼ì •ì´ í•„ìš”í•˜ê³ , êº¼ë‚¸ ê°ì²´ê°€ nullable í•˜ë¯€ë¡œ í˜ìŠ¤íƒ€ê³ ì˜ ì‹¤ì œ ì½”ë“œì—ì„œëŠ” `RequestScope` ë²”ìœ„ì˜ ë¹ˆì„ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.\n"},{"excerpt":"ì„œë¡  ì•ˆë…•í•˜ì„¸ìš”. í˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ í˜ìŠ¤íƒ€ê³ ëŠ” ì¸ì¦ì„ êµ¬í˜„í•  ë•Œ, ìµœì†Œí•œì˜ ì •ë³´ë¡œ ì•ˆì „í•˜ê²Œ ì¸ì¦ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” OAuth2ë¥¼ ì±„íƒí•˜ì˜€ìŠµë‹ˆë‹¤. OAuth2ë¥¼ êµ¬í˜„í•  ë•Œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” íšŒì‚¬ë“¤ì€ ë§¤ìš° ë§ìŠµë‹ˆë‹¤. ê·¸ì¤‘ì—ì„œ ì €í¬ê°€ ì„ íƒí•œ OAuth2 ì œê³µìëŠ”  ì…ë‹ˆë‹¤. ì¹´ì¹´ì˜¤í†¡ì„ ì„ íƒí•œ ì´ìœ ëŠ” ì €í¬ ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ìƒ ì‚¬ìš©ì ê°„ì˜ í‹°ì¼“ ê±°ë˜ë¥¼ ë§‰ê¸° ìœ„â€¦","fields":{"slug":"/oauth2-select-and-apply/"},"frontmatter":{"date":"August 20, 2023","title":"í˜ìŠ¤íƒ€ê³ ì˜ ì¸ì¦ - OAuth2ë¥¼ ì„ íƒí•˜ê³  ì ìš©í•œ ë°©ë²•","tags":["OAuth2"]},"rawMarkdownBody":"\n## ì„œë¡ \n\nì•ˆë…•í•˜ì„¸ìš”.\n\ní˜ìŠ¤íƒ€ê³ ì˜ ê¸€ë Œì…ë‹ˆë‹¤. ğŸ¥ƒ\n\ní˜ìŠ¤íƒ€ê³ ëŠ” ì¸ì¦ì„ êµ¬í˜„í•  ë•Œ, ìµœì†Œí•œì˜ ì •ë³´ë¡œ ì•ˆì „í•˜ê²Œ ì¸ì¦ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” OAuth2ë¥¼ ì±„íƒí•˜ì˜€ìŠµë‹ˆë‹¤.\n\nOAuth2ë¥¼ êµ¬í˜„í•  ë•Œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” íšŒì‚¬ë“¤ì€ ë§¤ìš° ë§ìŠµë‹ˆë‹¤.\n\nê·¸ì¤‘ì—ì„œ ì €í¬ê°€ ì„ íƒí•œ OAuth2 ì œê³µìëŠ” `ì¹´ì¹´ì˜¤í†¡` ì…ë‹ˆë‹¤.\n\nì¹´ì¹´ì˜¤í†¡ì„ ì„ íƒí•œ ì´ìœ ëŠ” ì €í¬ ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ìƒ ì‚¬ìš©ì ê°„ì˜ í‹°ì¼“ ê±°ë˜ë¥¼ ë§‰ê¸° ìœ„í•¨ì¸ë°ìš”.\n\nêµ¬ê¸€ì´ë‚˜ í˜ì´ìŠ¤ë¶ ë“± ì‰½ê²Œ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ëŠ” í•œ ëª…ì˜ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê³„ì •ì„ í†µí•´ í‹°ì¼“ì„ ì˜ˆë§¤í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, êµ­ë‚´ì—ì„œ ìœ ì¼í•œ ì „í™”ë²ˆí˜¸ë¡œ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ì œê³µìì¸ ì¹´ì¹´ì˜¤í†¡ì„ ì„ íƒí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜ìŠ¤íƒ€ê³ ì—ì„œ êµ¬í˜„í•œ OAuth2ì˜ ì¸ì¦ í”Œë¡œìš°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n![](images/20230819155223.png)\n\nì´ ë°©ì‹ì€ `Authorization Code Grant Type`ë¼ê³  ë¶ˆë¦¬ëŠ” OAuth2 ì¸ì¦ ë°©ì‹ì˜ ì¢…ë¥˜ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\n\ní•´ë‹¹ ì¸ì¦ ë°©ì‹ì€ ì‚¬ìš©ìëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” OAuth2 ì¸ì¦ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³ , ì¸ì¦ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸(ë°±ì—”ë“œ ìŠ¤í”„ë§ ì„œë²„)ì— ì—‘ì„¸ìŠ¤ í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.\n\nì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì—‘ì„¸ìŠ¤ í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ì˜ ë…¸ì¶œì„ ìµœì†Œí™”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì•ˆì˜ ì‹ ë¢°ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\n\nì´ëŸ¬í•œ ë°©ì‹ì„ ì–´ë–»ê²Œ ì½”ë“œë¡œ êµ¬í˜„í•˜ì˜€ëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.\n\nì½”ë“œë¡œ êµ¬í˜„í•  í´ë˜ìŠ¤ë¥¼ ê°„ëµíˆ ë‚˜íƒ€ë‚¸ë‹¤ë©´ í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n\n`SocialType`: Enumìœ¼ë¡œ OAuth2ì˜ ì œê³µìë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. (ex: KAKAO)\n\n`AuthProvider`: ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì €í¬ì˜ ì—‘ì„¸ìŠ¤ í† í°ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.\n\n`AuthExtractor`: ì—‘ì„¸ìŠ¤ í† í°ì„ íŒŒì‹±í•˜ì—¬ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ê³  Payloadì˜ ê°’ì„ ì¶”ì¶œí•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.\n\n`OAuth2Client`: OAuth2 ì¸ì¦, ë¦¬ì†ŒìŠ¤ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ì—‘ì„¸ìŠ¤ í† í°, ì‚¬ìš©ì ì •ë³´ ë“± ë¯¼ê°í•œ ì •ë³´ë¥¼ ë°›ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.\n\n`Member`: ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” ì—”í‹°í‹°ë¡œ, `SocialType`ì„ í•„ë“œë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.\n\n`AuthService`: ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ ë ˆì´ì–´ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.\n\nì—¬ê¸°ì„œ `OAuth2Client`ëŠ” ì™¸ë¶€ APIì— ì˜ì¡´í•˜ë¯€ë¡œ, ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ë‚˜ ë¡œì»¬ í™˜ê²½ì—ì„œ ëª¨ì˜ ê°ì²´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.\n#### AuthProvider\n```java\npublic class JwtAuthProvider implements AuthProvider {  \n  \n    private static final int SECOND_FACTOR = 60;  \n    private static final int MILLISECOND_FACTOR = 1000;  \n    private static final String MEMBER_ID_KEY = \"memberId\";\n  \n    private final SecretKey key;  \n    private final long expirationMinutes;  \n  \n    public JwtAuthProvider(String secretKey, long expirationMinutes) {  \n        this.key = Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8));  \n        this.expirationMinutes = expirationMinutes;  \n    }  \n  \n    @Override  \n    public String provide(AuthPayload authPayload) {  \n        Date now = new Date();  \n        return Jwts.builder()  \n            .claim(MEMBER_ID_KEY, authPayload.getMemberId())   \n            .setIssuedAt(now)  \n            .setExpiration(new Date(now.getTime() + expirationMinutes * SECOND_FACTOR * MILLISECOND_FACTOR))  \n            .signWith(key, SignatureAlgorithm.HS256)  \n            .compact();  \n    }  \n}\n```\n\nAuthProviderì˜ êµ¬í˜„ì²´ì¸ `JwtAuthProvider` ì…ë‹ˆë‹¤.\n\n`Member` ì—”í‹°í‹°ì˜ PKë¥¼ Payloadì— ë„£ì–´ JWT í† í°ì„ ë°˜í™˜í•´ ì¤ë‹ˆë‹¤.\n\ní•´ë‹¹ í† í°ì€ ì•ìœ¼ë¡œ ì €í¬ ì„œë²„ì— ì¸ì¦ ê³¼ì •ì— í•„ìš”í•œ ì—‘ì„¸ìŠ¤ í† í°ì…ë‹ˆë‹¤.\n\n#### AuthExtractor\n```java\npublic class JwtAuthExtractor implements AuthExtractor {  \n  \n    private static final String MEMBER_ID_KEY = \"memberId\";  \n  \n    private final JwtParser jwtParser;  \n  \n    public JwtAuthExtractor(String secretKey) {  \n        SecretKey key = Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8));  \n        this.jwtParser = Jwts.parserBuilder()  \n            .setSigningKey(key)  \n            .build();  \n    }  \n  \n    @Override  \n    public AuthPayload extract(String token) {  \n        Claims claims = getClaims(token);  \n        Long memberId = claims.get(MEMBER_ID_KEY, Long.class);  \n        return new AuthPayload(memberId);  \n    }  \n  \n    private Claims getClaims(String code) {  \n        try {  \n            return jwtParser.parseClaimsJws(code)  \n                .getBody();  \n        } catch (ExpiredJwtException e) {  \n            throw new UnauthorizedException(ErrorCode.EXPIRED_AUTH_TOKEN);  \n        } catch (JwtException | IllegalArgumentException e) {  \n            throw new UnauthorizedException(ErrorCode.INVALID_AUTH_TOKEN);  \n        }  \n    }  \n}\n```\n\nAuthExtractorì˜ êµ¬í˜„ì²´ì¸ `JwtAuthExtractor` ì…ë‹ˆë‹¤.\n\ní† í°ì„ ë°›ì•„ `AuthPayload` ê°ì²´ë¡œ ë§Œë“¤ì–´ ë°˜í™˜í•©ë‹ˆë‹¤.\n\nì°¸ê³ ë¡œ í•„ë“œë¡œ `JwtParser`ë¥¼ ê°€ì§€ê³  ìˆëŠ”ë° ì´ëŠ” `Jwts.parserBuilder()` ë©”ì†Œë“œë¡œ ìƒì„±ëœ ì¸ìŠ¤í„´ìŠ¤ëŠ” ë¶ˆë³€í•˜ê³ , thread-safe í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\n\n![](images/20230818023037.png)\n\në”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ íŒŒì‹±í•  ë•Œë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒˆë¡­ê²Œ ë§Œë“¤ì§€ ì•Šê³ , ê¸°ì¡´ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n// íŒŒì‹±ë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\nreturn Jwts.parserBuilder()  \n            .setSigningKey(key)  \n            .build()\n            .parseClaimsJws(code)  \n            .getBody();\n\n// íŒŒì‹±ë§ˆë‹¤ ê¸°ì¡´ì˜ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©\nreturn jwtParser.parseClaimsJws(code)  \n                .getBody();  \n```\n\n#### OAuth2Client\n```java\n@Component\npublic class KakaoOAuth2Client implements OAuth2Client {  \n  \n    private static final String ACCESS_TOKEN_URL = \"https://kauth.kakao.com/oauth/token\";  \n    private static final String USER_INFO_URL = \"https://kapi.kakao.com/v2/user/me\";  \n  \n    private final RestTemplate restTemplate;  \n    private final String grantType;  \n    private final String clientId;  \n    private final String redirectId;  \n  \n    public KakaoOAuth2Client(  \n        @Value(\"${festago.oauth2.kakao.grant-type}\") String grantType,  \n        @Value(\"${festago.oauth2.kakao.client-id}\") String clientId,  \n        @Value(\"${festago.oauth2.kakao.redirect-uri}\") String redirectUri,  \n        RestTemplateBuilder restTemplateBuilder  \n    ) {  \n        this.grantType = grantType;  \n        this.clientId = clientId;  \n        this.redirectId = redirectUri;  \n        this.restTemplate = restTemplateBuilder.build();  \n    }  \n  \n    public String getAccessToken(String code) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.add(\"grant_type\", grantType);  \n        headers.add(\"client_id\", clientId);  \n        headers.add(\"redirect_uri\", redirectId);  \n        headers.add(\"code\", code);  \n  \n        try {  \n            KakaoAccessTokenResponse response = restTemplate.postForEntity(  \n                ACCESS_TOKEN_URL, headers,  \n                KakaoAccessTokenResponse.class).getBody();  \n            return response.accessToken();  \n        } catch (HttpClientErrorException e) {  \n            KakaoOAuth2Error kakaoOAuth2Error = e.getResponseBodyAs(KakaoOAuth2Error.class);  \n            if (kakaoOAuth2Error.isErrorCodeKOE320()) {  \n                throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  \n            }  \n            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  \n        }  \n    }  \n  \n    public UserInfo getUserInfo(String accessToken) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.setBearerAuth(accessToken);  \n  \n        try {  \n            KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  \n                    KakaoUserInfo.class)  \n                .getBody();  \n            return UserInfo.ofKakao(kakaoUserInfo);  \n        } catch (HttpClientErrorException e) {  \n            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  \n        }  \n    }  \n  \n    public record KakaoOAuth2Error(  \n        String error,  \n        @JsonProperty(\"error_description\") String errorDescription,  \n        @JsonProperty(\"error_code\") String errorCode  \n    ) {  \n  \n        public boolean isErrorCodeKOE320() {  \n            return errorCode.equals(\"KOE320\");  \n        }  \n    }  \n}\n```\n\nì‹¤ì œ ì¹´ì¹´ì˜¤ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìì—ê²Œ ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” `KakaoOAuth2Client` ì…ë‹ˆë‹¤.\n\nì½”ë“œì— ì§€ì €ë¶„í•œ ê³³ì´ ë§ê³ , ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€í‚¤ì§€ ì•ŠëŠ” ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. (ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­, ì‚¬ìš©ì ì •ë³´ ìš”ì²­)\n\nì¶”í›„ ì´ ë¶€ë¶„ì„ ì–´ë–»ê²Œ ê°œì„ í–ˆëŠ”ì§€ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\n> recordì— @JsonPropertyë¥¼ ì‚¬ìš©í•œ ì´ìœ ëŠ” [ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš° ë§í¬](https://stackoverflow.com/questions/68394911/why-record-class-cant-be-properly-deserialized-with-jackson)ì— ë‚˜ì™€ ìˆìŠµë‹ˆë‹¤.\n\n#### AuthService\n```java\n@Service\n@Transactional\npublic class AuthService {  \n  \n    private final MemberRepository memberRepository;  \n    private final OAuth2Client oAuth2Client;  \n    private final AuthProvider authProvider;  \n  \n    public AuthService(MemberRepository memberRepository, OAuth2Client oAuth2Client, AuthProvider authProvider) {  \n        this.memberRepository = memberRepository;  \n        this.oAuth2Client = oAuth2Client;  \n        this.authProvider = authProvider;  \n    }  \n  \n    public LoginResponse login(String code) {  \n        String accessToken = oAuth2Client.getAccessToken(code);  \n        UserInfo userInfo = oAuth2Client.getUserInfo(accessToken);  \n        Member member = memberRepository.findBySocialIdAndSocialType(userInfo.socialId(), userInfo.socialType())  \n            .orElseGet(() -> memberRepository.save(userInfo.toMember()));  \n        return new LoginResponse(authProvider.provide(member), userInfo.nickname());  \n    }  \n}\n```\n\nì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë³´ë‚´ì˜¨ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.\n\níë¦„ì€ ë§¨ ìœ„ì—ì„œ ì„¤ëª…í•œ ê²ƒê³¼ ê°™ì´ ì½”ë“œë¥¼ ë°›ì•„, OAuth2 ì„œë¹„ìŠ¤ ì œê³µìë¡œë¶€í„° ì•¡ì„¸ìŠ¤ í† í°ì„ ì–»ê³ , ì‚¬ìš©ì ì •ë³´ë¥¼ ì–»ì€ ë’¤ ê¸°ì¡´ì˜ íšŒì›ì´ ìˆìœ¼ë©´ `AuthProvider`ë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜í•˜ê³ , ê¸°ì¡´ì˜ íšŒì›ì´ ì—†ë‹¤ë©´ `orElseGet()` ë©”ì„œë“œë¥¼ í†µí•´ íšŒì›ì„ ìƒì„±í•˜ê³  ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤.\n\n---\n\nì´ë ‡ê²Œ êµ¬í˜„í•œ ë°©ì‹ì—ëŠ” ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤.\n\n`OAuth2Client`ì˜ ì½”ë“œë¥¼ ë³´ë©´ ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€í‚¤ì§€ ëª»í–ˆê³ (ì•¡ì„¸ìŠ¤ ì½”ë“œì™€ ì‚¬ìš©ì ì •ë³´ë¥¼ ëª¨ë‘ ê´€ë¦¬) ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ try-catchë¬¸ ë•Œë¬¸ì— ì½”ë“œì˜ ê°€ë…ì„±ì´ ë‚˜ì©ë‹ˆë‹¤.\n\nê·¸ë¦¬ê³  `OAuth2Client`ë¥¼ ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜í•˜ì—¬ ë³€ê²½ì—ëŠ” ìœ ì—°í•˜ê²Œ ëŒ€ì‘í–ˆì§€ë§Œ, ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ì¶”ê°€ë  ê²½ìš° ìƒˆë¡œìš´ í´ë˜ìŠ¤ í˜¹ì€ ë©”ì†Œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n### ë‹¨ì¼ ì±…ì„ ì›ì¹™ì˜ ë¶„ë¦¬\n\nìœ ëª…í•œ ê°ì²´ ì§€í–¥ ì›ì¹™ì¸ SOLID ì›ì¹™ì—ì„œ SëŠ” ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ëœ»í•©ë‹ˆë‹¤.\n\nìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ë©°, ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•œ OCP, DIP ì›ì¹™ì€ ë§¤ìš° ì‰½ê²Œ ì§€í‚¬ ìˆ˜ ìˆìœ¼ë‚˜, SRP ì›ì¹™ì€ êµ¬í˜„í•˜ëŠ” ê°œë°œìê°€ ê°ì²´ê°€ ê°€ì§€ëŠ” ì±…ì„ì„ ì–¼ë§ˆë‚˜ ì˜ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ”ì§€ì— ë”°ë¼ ë‹¬ë ¸ìŠµë‹ˆë‹¤.\n\nOAuth2ClientëŠ” ë‘ ê°€ì§€ ì¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.\n1. ì•¡ì„¸ìŠ¤ í† í°ì„ ìš”ì²­\n2. ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­\n\në‘ ê°€ì§€ ì¼ì€ OAuth2 ì¸ì¦ì˜ íë¦„ìœ¼ë¡œëŠ” í•˜ë‚˜ì˜ ì‘ì—…ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆê² ì§€ë§Œ ê°ì²´ê°€ ê°€ì§€ëŠ” ì±…ì„ì€ ë‘ ê°€ì§€ ì±…ì„ì„ ì§€ê³  ìˆìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ, ì—‘ì„¸ìŠ¤ í† í°ë§Œ ìš”ì²­í•˜ëŠ” í´ë˜ìŠ¤ì™€ ì‚¬ìš©ì ì •ë³´ë§Œ ìš”ì²­í•˜ëŠ” í´ë˜ìŠ¤ë¡œ ë‚˜ëˆ  ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n#### KakaoOAuth2AccessTokenClient\n```java\n@Component\npublic class KakaoOAuth2AccessTokenClient {  \n  \n    private static final String URL = \"https://kauth.kakao.com/oauth/token\";  \n  \n    private final RestTemplate restTemplate;  \n    private final String grantType;  \n    private final String clientId;  \n    private final String redirectUri;  \n  \n    public KakaoOAuth2AccessTokenClient(  \n        @Value(\"${festago.oauth2.kakao.grant-type}\") String grantType,  \n        @Value(\"${festago.oauth2.kakao.client-id}\") String clientId,  \n        @Value(\"${festago.oauth2.kakao.redirect-uri}\") String redirectUri,\n        @Value(\"${festago.oauth2.kakao.client-secret}\") String clientSecret,  \n        RestTemplateBuilder restTemplateBuilder  \n    ) {  \n        this.grantType = grantType;  \n        this.clientId = clientId;  \n        this.redirectUri = redirectUri;  \n        this.clientSecret = clientSecret;\n        this.restTemplate = restTemplateBuilder.build();  \n    }  \n  \n    public String getAccessToken(String code) {  \n        HttpHeaders headers = getAccessTokenHeaders(code);  \n        return requestAccessToken(headers);  \n    }  \n  \n    private HttpHeaders getAccessTokenHeaders(String code) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.set(\"grant_type\", grantType);  \n        headers.set(\"client_id\", clientId);  \n        headers.set(\"redirect_uri\", redirectUri);  \n        headers.set(\"client_secret\", clientSecret);\n        headers.set(\"code\", code);  \n        return headers;  \n    }  \n  \n    private String requestAccessToken(HttpHeaders headers) {  \n        try {  \n            KakaoAccessTokenResponse response = restTemplate.postForEntity(ACCESS_TOKEN_URL, headers,  \n                KakaoAccessTokenResponse.class).getBody();  \n            return response.accessToken();  \n        } catch (HttpClientErrorException e) {  \n            KakaoOAuth2Error kakaoOAuth2Error = e.getResponseBodyAs(KakaoOAuth2Error.class);  \n            if (kakaoOAuth2Error.isErrorCodeKOE320()) {  \n                throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  \n            }  \n            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  \n        }  \n    }\n}\n```\n\n#### KakaoOAuth2UserInfoClient\n```java\n@Component\npublic class KakaoOAuth2UserInfoClient {  \n  \n    private static final String URL = \"https://kapi.kakao.com/v2/user/me\";  \n  \n    private final RestTemplate restTemplate;  \n  \n    public KakaoOAuth2UserInfoClient(RestTemplateBuilder restTemplateBuilder) {  \n        this.restTemplate = restTemplateBuilder.build();  \n    }  \n  \n    public UserInfo getUserInfo(String accessToken) {  \n        HttpHeaders headers = getUserInfoHeaders(accessToken);  \n        return requestUserInfo(headers);  \n    }  \n  \n    private HttpHeaders getUserInfoHeaders(String accessToken) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.setBearerAuth(accessToken);  \n        return headers;  \n    }  \n  \n    private UserInfo requestUserInfo(HttpHeaders headers) {  \n        try {  \n            KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  \n                    KakaoUserInfo.class)  \n                .getBody();  \n            return kakaoUserInfo.toUserInfo();  \n        } catch (HttpClientErrorException e) {  \n            throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR, e);  \n        }\n    }\n}\n```\n\nê·¸ë¦¬ê³  ê¸°ì¡´ì˜ `KakaoOAuth2Client`ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@Component  \npublic class KakaoOAuth2Client implements OAuth2Client {\n\n    private final KakaoOAuth2AccessTokenClient accessTokenClient;  \n    private final KakaoOAuth2UserInfoClient userInfoClient;\n    \n    public KakaoOAuth2Client(KakaoOAuth2AccessTokenClient accessTokenClient, KakaoOAuth2UserInfoClient userInfoClient) {  \n        this.accessTokenClient = accessTokenClient;  \n        this.userInfoClient = userInfoClient;  \n    }\n\n    public String getAccessToken(String code) {  \n        return accessTokenClient.getAccessToken(code)\n    }  \n  \n    public UserInfo getUserInfo(String accessToken) {  \n        return userInfoClient.getUserInfo(accessToken);\n    }  \n}\n```\n\nì´ì œë¶€í„° `KakaoOAuth2Client` í´ë˜ìŠ¤ëŠ” ì±…ì„ì„ ë¶„ë¦¬í•œ í´ë˜ìŠ¤ì— ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.\n\n#### ResponseErrorHandler\n\ní•˜ì§€ë§Œ ì•„ì§ë„ ì—¬ì „íˆ ì¶”í•œ try-catchê°€ ì½”ë“œì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.\n\n`RestTemplate` í´ë˜ìŠ¤ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì–´ì©” ìˆ˜ ì—†ì´ try-catchë¬¸ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.\n\nê·¸ëŸ°ë° ì—¬ê¸°ì„œ ì ê¹,\n\nì €í¬ëŠ” ìŠ¤í”„ë§ì„ ì‚¬ìš©í•˜ë©° ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤ ë ˆì´ì–´ì— try-catchë¥¼ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì˜¤íˆë ¤ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë˜ì ¸ë²„ë¦½ë‹ˆë‹¤.\n\nê·¸ëŸ¬ëŠ” ì´ìœ ëŠ” ìš”ì²­ì˜ ì˜ˆì™¸ë¥¼ ì „ì—­ì ìœ¼ë¡œ ì²˜ë¦¬í•´ ì£¼ëŠ” `@ControllerAdvice`ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\n\n`RestTemplate` í´ë˜ìŠ¤ì—ì„œë„ `@ControllerAdvice` ê°™ì€ ì—­í• ì„ í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤.\n\në°”ë¡œ `ResponseErrorHandler` ì…ë‹ˆë‹¤.\n\n`ResponseErrorHandler`ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë‘ ê°œì˜ ì¶”ìƒ ë©”ì†Œë“œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic interface ResponseErrorHandler {\n\n    boolean hasError(ClientHttpResponse response) throws IOException;\n    \n    void handleError(ClientHttpResponse response) throws IOException;\n}\n```\n\nì‚¬ì‹¤ ì´ë¯¸ `RestTemplate`ì—ì„œëŠ” ê¸°ë³¸ì ì¸ `ResponseErrorHandler`ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic class RestTemplate extends InterceptingHttpAccessor implements RestOperations {\n    ...\n    private ResponseErrorHandler errorHandler = new DefaultResponseErrorHandler();\n    ...\n}\n```\n\në”°ë¼ì„œ ê¸°ì¡´ì˜ `ResponseErrorHandler`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì»¤ìŠ¤í…€í•œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ë©´ ì˜ˆì™¸ ì²˜ë¦¬ì— ê´€í•œ ë¡œì§ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n#### KakaoOAuth2AccessTokenErrorHandler\n```java\npublic class KakaoOAuth2AccessTokenErrorHandler extends DefaultResponseErrorHandler {  \n  \n    @Override  \n    public void handleError(ClientHttpResponse response) throws IOException {  \n        try {  \n            super.handleError(response);  \n        } catch (HttpStatusCodeException e) {  \n            HttpStatusCode statusCode = response.getStatusCode();  \n            handle4xxError(statusCode, e);  \n            handle5xxError(statusCode);  \n        }  \n        throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR);  \n    }  \n  \n    private void handle4xxError(HttpStatusCode statusCode, HttpStatusCodeException e) {  \n        if (statusCode.is4xxClientError()) {  \n            KakaoOAuth2ErrorResponse errorResponse = e.getResponseBodyAs(KakaoOAuth2ErrorResponse.class);  \n            handleErrorCode(errorResponse);  \n        }  \n    }  \n  \n    private void handleErrorCode(KakaoOAuth2ErrorResponse errorResponse) {  \n        handleKOE320Error(errorResponse);  \n        throw new InternalServerException(ErrorCode.OAUTH2_INVALID_REQUEST);  \n    }  \n  \n    private void handleKOE320Error(KakaoOAuth2ErrorResponse errorResponse) {  \n        if (errorResponse != null && errorResponse.isErrorCodeKOE320()) {  \n            throw new BadRequestException(ErrorCode.OAUTH2_INVALID_CODE);  \n        }  \n    }  \n  \n    private void handle5xxError(HttpStatusCode statusCode) {  \n        if (statusCode.is5xxServerError()) {  \n            throw new InternalServerException(ErrorCode.OAUTH2_PROVIDER_NOT_RESPONSE);  \n        }  \n    }  \n  \n    public record KakaoOAuth2ErrorResponse(  \n        String error,  \n        @JsonProperty(\"error_description\") String errorDescription,  \n        @JsonProperty(\"error_code\") String errorCode  \n    ) {  \n  \n        public boolean isErrorCodeKOE320() {  \n            return Objects.equals(errorCode, \"KOE320\");  \n        }  \n    }  \n}\n```\n\n#### KakaoOAuth2UserInfoErrorHandler\n```java\npublic class KakaoOAuth2UserInfoErrorHandler extends DefaultResponseErrorHandler {  \n  \n    @Override  \n    public void handleError(ClientHttpResponse response) throws IOException {  \n        HttpStatusCode statusCode = response.getStatusCode();  \n        handle4xxError(statusCode);  \n        handle5xxError(statusCode);  \n        throw new InternalServerException(ErrorCode.INTERNAL_SERVER_ERROR);  \n    }  \n  \n    private void handle4xxError(HttpStatusCode statusCode) {  \n        if (statusCode.is4xxClientError()) {  \n            throw new InternalServerException(ErrorCode.OAUTH2_INVALID_REQUEST);  \n        }  \n    }  \n  \n    private void handle5xxError(HttpStatusCode statusCode) {  \n        if (statusCode.is5xxServerError()) {  \n            throw new InternalServerException(ErrorCode.OAUTH2_PROVIDER_NOT_RESPONSE);  \n        }  \n    }  \n}\n```\n\ní•´ë‹¹ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¥¼ ì ìš©í•œ OAuth2ClientëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œê°€ ë³€ê²½ë©ë‹ˆë‹¤.\n#### KakaoOAuth2AccessTokenClient\n```java\n@Component\npublic class KakaoOAuth2AccessTokenClient {  \n  \n    private static final String URL = \"https://kauth.kakao.com/oauth/token\";  \n  \n    private final RestTemplate restTemplate;  \n    private final String grantType;  \n    private final String clientId;  \n    private final String redirectUri;  \n  \n    public KakaoOAuth2AccessTokenClient(  \n        @Value(\"${festago.oauth2.kakao.grant-type}\") String grantType,  \n        @Value(\"${festago.oauth2.kakao.client-id}\") String clientId,  \n        @Value(\"${festago.oauth2.kakao.redirect-uri}\") String redirectUri,\n        @Value(\"${festago.oauth2.kakao.client-secret}\") String clientSecret,  \n        RestTemplateBuilder restTemplateBuilder  \n    ) {  \n        this.grantType = grantType;  \n        this.clientId = clientId;  \n        this.redirectUri = redirectUri;  \n        this.clientSecret = clientSecret;\n        this.restTemplate = restTemplateBuilder\n            .errorHandler(new KakaoOAuth2AccessTokenErrorHandler())\n            .build();  \n    }  \n  \n    public String getAccessToken(String code) {  \n        HttpHeaders headers = getAccessTokenHeaders(code);  \n        return requestAccessToken(headers);  \n    }  \n  \n    private HttpHeaders getAccessTokenHeaders(String code) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.set(\"grant_type\", grantType);  \n        headers.set(\"client_id\", clientId);  \n        headers.set(\"redirect_uri\", redirectUri);  \n        headers.set(\"client_secret\", clientSecret);\n        headers.set(\"code\", code);  \n        return headers;  \n    }  \n  \n    private String requestAccessToken(HttpHeaders headers) {  \n        KakaoAccessTokenResponse response = restTemplate.postForEntity(ACCESS_TOKEN_URL, headers,  \n            KakaoAccessTokenResponse.class).getBody();  \n        return response.accessToken();  \n    }\n}\n```\n\n#### KakaoOAuth2UserInfoClient\n```java\n@Component\npublic class KakaoOAuth2UserInfoClient {  \n  \n    private static final String URL = \"https://kapi.kakao.com/v2/user/me\";  \n  \n    private final RestTemplate restTemplate;  \n  \n    public KakaoOAuth2UserInfoClient(RestTemplateBuilder restTemplateBuilder) {  \n        this.restTemplate = restTemplateBuilder\n            .errorHandler(new KakaoOAuth2UserInfoErrorHandler())\n            .build();  \n    }  \n  \n    public UserInfo getUserInfo(String accessToken) {  \n        HttpHeaders headers = getUserInfoHeaders(accessToken);  \n        return requestUserInfo(headers);  \n    }  \n  \n    private HttpHeaders getUserInfoHeaders(String accessToken) {  \n        HttpHeaders headers = new HttpHeaders();  \n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);  \n        headers.setBearerAuth(accessToken);  \n        return headers;  \n    }  \n  \n    private UserInfo requestUserInfo(HttpHeaders headers) {  \n        KakaoUserInfo kakaoUserInfo = restTemplate.postForEntity(USER_INFO_URL, new HttpEntity<>(headers),  \n                KakaoUserInfo.class)  \n            .getBody();  \n        return kakaoUserInfo.toUserInfo();  \n    }\n}\n```\n\nì´ì²˜ëŸ¼ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì±…ì„ì„ ê°€ì§„ ê°ì²´ë¡œ ë¶„ë¦¬í•˜ì—¬, ìš”ì²­ì„ ë³´ë‚´ëŠ” ê°ì²´ì—ëŠ” ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œ í•˜ë‚˜ ì—†ì´ ì˜¤ë¡œì§€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê²Œ ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n### ìƒˆë¡œìš´ OAuth2 í´ë¼ì´ì–¸íŠ¸ì˜ ì¶”ê°€\n\nì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” `OAuth2Client`ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.\n\nì¸í„°í˜ì´ìŠ¤ë¡œ ì„¤ê³„í•˜ì—¬, OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ë°”ë€Œë”ë¼ë„ ì‰½ê²Œ êµì²´í•  ìˆ˜ ìˆê³ , ëª¨ì˜ OAuth2Client ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì™¸ë¶€ APIì˜ ì—°ë™ ì—†ì´ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ ì´ë ‡ê²Œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë§Œë“¤ì–´ë„, ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œê°€ í•˜ë‚˜ì´ê¸° ë•Œë¬¸ì— ì¶”ê°€ì ì¸ OAuth2Clientë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ ì œê³µìë§ˆë‹¤ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê±°ë‚˜, í•„ë“œì™€ ë©”ì†Œë“œê°€ ìƒê¸¸ ê²ƒì…ë‹ˆë‹¤.\n\n```java\npublic class KakaoOAuth2Service{\n    ...\n};\n\npublic class NaverOAuth2Service{\n    ...\n};\n\n// ë˜ëŠ”\n\npublic class AuthService {\n\n    private final OAuth2Client kakaoOAuth2Client;\n    private final OAuth2Client naverOAuth2Client;\n    \n    public void loginKakaoOAuth2(String code) {\n        ...\n    }\n    public void loginKakaoOAuth2(String code) {\n        ...\n    }\n}\n```\n\nì´ê²ƒì€ ë‹¨ì¼ ì±…ì„ ì›ì¹™ì„ ì§€ì¼°ë‹¤ê³  í•  ìˆ˜ ìˆê² ì§€ë§Œ, ì¤‘ë³µëœ ì½”ë“œê°€ ìƒê¸°ê²Œ ë˜ê³  ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì œê³µìê°€ ìƒê¸¸ ë•Œ ìƒˆë¡œìš´ ë©”ì†Œë“œë¥¼ ì¶”ê°€í•´ ì¤˜ì•¼ í•©ë‹ˆë‹¤.\n\nê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ì˜ í•„ë“œë¡œ ì—¬ëŸ¬ `OAuth2Client`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?\n\nìŠ¤í”„ë§ì€ ì˜ì¡´ì„±ì„ ì£¼ì…í•  ë•Œ ì»¬ë ‰ì…˜ìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì£¼ì…í•´ ì£¼ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.\n\në”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì—¬ëŸ¬ `OAuth2Client`ë¥¼ `List` í˜•ì‹ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic class AuthService {\n\n    private final List<OAuth2Client> oAuth2Clients;\n\n    public AuthService(List<OAuth2Client> oAuth2Clients) {\n        this.oAuth2Clients = oAuth2Clients;\n    }\n}\n```\n\nì´ê²ƒì´ ë°”ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì˜ì¡´í•˜ê²Œ í•˜ë©´ ì–»ì„ ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ì´ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\n\nê·¸ëŸ°ë°, ë‹¨ìˆœíˆ List íƒ€ì…ìœ¼ë¡œ ë°›ì•˜ë‹¤ê³  í•´ì„œ ëë‚˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.\n\në¦¬ìŠ¤íŠ¸ ì¤‘ì—ì„œ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì„ íƒí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\n\n```java\npublic OAuth2Client getClient(SocialType socialType) {\n    return oAuth2Clients.stream()\n        .filter(client -> client.getSocialType == socialType)\n        .findAny()\n        .orElseThrow(() -> BadRequestException(...));\n}\n```\n\nì´ë ‡ê²Œ Streamì„ í™œìš©í•´ì„œ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì„ íƒí•  ìˆ˜ ìˆê² ì§€ë§Œ, ë§¤ë²ˆ Streamì„ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì°¾ëŠ” ì‘ì—…ì€ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.\n\nì´ë•ŒëŠ” List ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒ ë³´ë‹¤ Map ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©´ íš¨ìœ¨ì ì¼ ê²ƒì…ë‹ˆë‹¤.\n\nìŠ¤í”„ë§ì€ Map íƒ€ì…ìœ¼ë¡œë„ ì˜ì¡´ì„± ì£¼ì…ì„ ì œê³µí•©ë‹ˆë‹¤.\n\ní•˜ì§€ë§Œ Mapìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ìœ¼ë©´ Keyê°€ Stringì¸ `kakaoOAuth2Client`ì™€ ê°™ì´ ì§€ì •ë©ë‹ˆë‹¤.\n\n```java\nprivate final Map<String, OAuth2Client> oAuth2ClientMap;\n```\n\në”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì˜ì¡´ì„± ì£¼ì…ì€ Listë¡œ ë°›ì€ ë’¤, ë‚´ë¶€ì—ì„œ Mapìœ¼ë¡œ ë³€í™˜ì‹œí‚¤ë©´ Keyê°€ Enum íƒ€ì…ì¸ Mapì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\nprivate final Map<SocialType, OAuth2Client> oAuth2ClientMap = new EnumMap<>(SocialType.class);\n\npublic AuthService(List<OAuth2Client> oAuth2Clients) {\n    for (OAuth2Client oAuth2Client: oAuth2Clients) {\n        oAuth2ClientMap.put(oAuth2Client.getSocialType(), oAuth2Client);\n    }\n}\n```\n\nì´ì œ ë‹¤ìŒê³¼ ê°™ì´ íŠ¹ì • í´ë¼ì´ì–¸íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\npublic OAuth2Clients getOAuth2Client(SocialType socialType) {\n    return Optional.ofNullable(oAuth2ClientMap.get(socialType))  \n        .orElseThrow(() -> new BadRequestException(...));\n}\n```\n\ní•˜ì§€ë§Œ ì´ê²ƒ ë˜í•œ ì™„ë²½í•˜ê²Œ í•´ê²°í•œ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.\n\ní•„ë“œì— `OAuth2Client`ì— ëŒ€í•œ ìë£Œêµ¬ì¡°ê°€ ê·¸ëŒ€ë¡œ ë…¸ì¶œì´ ë˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n`AuthService` í´ë˜ìŠ¤ì—ì„œ í•„ìš”í•œ ê¸°ëŠ¥ì€ SocialTypeì— ë§ëŠ” OAuth2Clientë§Œ ì„ íƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.\n\n`AuthService` í´ë˜ìŠ¤ëŠ” Mapì— ëŒ€í•œ ê¸°ëŠ¥ì„ ìì„¸íˆ ì•Œ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.\n\nì´ê²ƒì€ ì €í¬ê°€ ë ˆë²¨1ë¶€í„° ë°°ì›Œì˜¨ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\në°”ë¡œ `ì¼ê¸‰ ì»¬ë ‰ì…˜`ìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.\n\n```java\n@Component\npublic class OAuth2Clients {\n    private final Map<SocialType, OAuth2Client> oAuth2ClientMap = new EnumMap<>(SocialType.class);\n\n    public OAuth2Clients(List<OAuth2Client> oAuth2Clients) {\n        for (OAuth2Client oAuth2Client: oAuth2Clients) {\n            oAuth2ClientMap.put(oAuth2Client.getSocialType(), oAuth2Client);\n        }\n    }\n\n    public OAuth2Client getClient(SocialType socialType) {\n        return Optional.ofNullable(oAuth2ClientMap.get(socialType))  \n            .orElseThrow(() -> new BadRequestException(...));\n    }\n}\n```\n\nê·¸ë¦¬ê³  `AuthService`ì˜ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë³€í•©ë‹ˆë‹¤.\n\n```java\n@Service\n@Transactional\npublic class AuthService {\n    private final OAuth2Clients oAuth2Clients;\n\n    ...\n\n    public LoginResponse login(SocialType socialType, String code) {  \n        OAuth2Client oAuth2Client = oAuth2Clients.getClient(socialType);\n        String accessToken = oAuth2Client.getAccessToken(code);  \n        UserInfo userInfo = oAuth2Client.getUserInfo(accessToken);  \n        Member member = memberRepository.findBySocialIdAndSocialType(userInfo.socialId(), socialType)  \n            .orElseGet(() -> memberRepository.save(userInfo.toMember()));  \n        return new LoginResponse(authProvider.provide(member), userInfo.nickname());  \n    }  \n} \n```\n\nì´ì œ ìƒˆë¡œìš´ OAuth2Clientê°€ ì¶”ê°€ë˜ì–´ë„ ê¸°ì¡´ì˜ ì½”ë“œë¥¼ ë³€ê²½í•  í•„ìš”ëŠ” ì „í˜€ ì—†ì–´ì§‘ë‹ˆë‹¤.\n\në˜í•œ ë¡œì»¬ í™˜ê²½ ë˜ëŠ” í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•œ ëª¨ì˜ OAuth2Clientë¥¼ ë§Œë“¤ë”ë¼ë„ `@Profile`  ì–´ë…¸í…Œì´ì…˜ì˜ ì‚¬ìš©ìœ¼ë¡œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì „í˜€ ì˜í–¥ì„ ì£¼ì§€ ì•Šê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n```java\n@Component  \n@Profile(\"!prod\")  \npublic class FestagoOAuth2Client implements OAuth2Client {  \n  \n    private static final String PROFILE_IMAGE = \"https://placehold.co/150x150\";  \n  \n    private final Map<String, UserInfo> userInfoMap = new HashMap<>();  \n  \n    public FestagoOAuth2Client() {  \n        userInfoMap.put(\"1\", new UserInfo(\"1\", getSocialType(), \"member1\", PROFILE_IMAGE));  \n        userInfoMap.put(\"2\", new UserInfo(\"2\", getSocialType(), \"member2\", PROFILE_IMAGE));  \n        userInfoMap.put(\"3\", new UserInfo(\"3\", getSocialType(), \"member3\", PROFILE_IMAGE));  \n    }  \n  \n    @Override  \n    public UserInfo getUserInfo(String accessToken) {  \n        return Optional.ofNullable(userInfoMap.get(accessToken))\n            .orElseThrow(() -> new BadRequestException(...));\n    }  \n  \n    @Override  \n    public SocialType getSocialType() {  \n        return SocialType.FESTAGO;  \n    }  \n}\n```\n\n## ê²°ë¡ \n\nOAuth2ë¥¼ ì‚¬ìš©í•œ ì¸ì¦ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ë•Œ, ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì˜ì¡´ì„± ì£¼ì… ê¸°ëŠ¥ê³¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œ ë‹¤í˜•ì„± í™œìš© ë“±, ê°ì²´ ì§€í–¥ ì„¤ê³„ë¥¼ ë”°ë¼ ì½”ë“œë¥¼ êµ¬í˜„í•˜ë©´ ë³€ê²½ì— ìœ ì—°í•˜ê³  ê°€ë…ì„±ì´ ë†’ì€ ì½”ë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nì €í¬ ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ ìƒˆë¡œìš´ OAuth2 ì„œë¹„ìŠ¤ ì œê³µìê°€ ì¶”ê°€ë  í™•ë¥ ì€ ë‚®ê² ì§€ë§Œ, ë ˆë²¨ 1, 2 ê³¼ì •ì„ ë°°ìš°ë©° ìŠµë“í•œ ê°ì²´ ì§€í–¥ ì„¤ê³„ ì›ì¹™ì„ ì´ë ‡ê²Œ ì„œë¹„ìŠ¤ì— ë…¹ì—¬ëƒˆë‹¤ëŠ” ì ì´ ë¿Œë“¯í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\n"}]}},"pageContext":{}},"staticQueryHashes":[],"slicesMap":{}}